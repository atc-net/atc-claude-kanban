<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ATC Claude Kanban</title>
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDcuMS1jMDAwIDc5LmRhYmFjYmIsIDIwMjEvMDQvMTQtMDA6Mzk6NDQgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCAyMy4wIChNYWNpbnRvc2gpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjc5NzgyNDI2NkZCRTExRUM4NEI0QzUxMEU0NkFFNzgwIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjc5NzgyNDI3NkZCRTExRUM4NEI0QzUxMEU0NkFFNzgwIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6Nzk3ODI0MjQ2RkJFMTFFQzg0QjRDNTEwRTQ2QUU3ODAiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6Nzk3ODI0MjU2RkJFMTFFQzg0QjRDNTEwRTQ2QUU3ODAiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz68h7bJAAAL30lEQVR42uydC3AV5RXHz73ZJBASYgIIFsEgBAgxFBgUbAcNFFG0dhCrolB1pjJIH0LR8lKxUC0KUsFRsWN1xEeLMAVrq7bYgdgUVIqADyCQoBgMr7QhIeTmQZLb/7n7UTfckMm9uY/d/c6Z+c9eneHe3e//y57z7X571uP3+8nj8ZDENzFz8mtXY3MvNG/1hmmlbj1O9t4rdrca/BcxBdoPGBZDKW49UAGg7egELYIOAIKpkEcA0DN6Q69BHwCC0QKAvjFKQfAK1FsA0Dd+pNLCIqizAKBncGG4GCoCBLc5tT4QADoefaG1UCEgGCkA6BvfhbYDgpehXgKAvtcP7oKKAcECqJMAoGekQr+B9gGCWwQAfSMLWgcICqBhAoC+wfcWdgKCF6CeAoC+9cE9qj6YCyUJAHpGGvQEtBcQTBIA9I3+0EZAsBkaKgDoG2NVfbAa6iEA6BkJZC5A4fpgTizrAwHAXpEOrYA+BwQ3CAD6Rjb0V0DwdyhXANA3JkCfAIJnoEwBQN/64KdQCSC4DzIEAD0jA1oFfQYIJgoA+sZg6B1A8DY0SADQN65Xs4WVUIYAoGdwPTBL1Qczw6kPBAB3BM8QnoN2AYJrBAB94zJoEyB4C8oWAPSNG6E9gGA5lC4A6BmJ0ANk3l+YASUIAHoG32F8nsw7jvlaAvCPkup8aGAI/6QI2uKyYeA1B1sAwQbo0rP/0+Pm/gAwnQ/0SegmaOz4AWkFofx7tWKH/31/lw1NQ3Ki99mn1t4+x+tS49Ogx/FxnzI/rFi9Ydqb2PDduPlQtRvGhv/Us7p3SZqQ2/MXZy8kuMl4BvpuMtfkR2T1LSCox+YJfuIH20ehH6txdFx0T02mYX3TKaNLkvtqAJh/FTY7oBcjZf45IByHpuPjCKjQSWOTkpRAo/tn0ticHi3Md8UZAMZnkbnK9tZY/B4g2I3NVeqJn2VkPvxhyzC8Hhp0URoN6pVGCV6Pu64DwPhU6DGV52+N9e8DhPXY5EALodN2G59LuqXQdUN70ZBvdT2v+Y48A8B0Phpu0MBF3kXx3BdAUIfNUpwN1qi648541wfdUpOQ5y+gzC7tW1fqdZj538HmI2hNvM0/B4QjEBefV0Bb47EPnZHnR12aSeNyLmy3+Y4BAMb3gf6oBvdyu+4nIOAidAx0O3Q4Fr/Jp3c+zU/M60V9u4Xezc6wufF8RHOVHNGLBxD4sVmLtPBnbH8JzSOznUzEo29mCuX1SQ9U+WEXijbO83eo6t6R3bgAQi02SwDCi6pemRap7+ap3HDkec73HQ2vDc3nPLqNzL58jm/FBhDKIC5ar1T1S/h5PjGBLu+XSeOHXBgR820FAIzvDb2iBslVzRgVCB8qCPhMUBZqns/BfJ6ndVndI5tNDBsYz7md71vPj1autFl98DrSwkZ1vFwjtNlH6OLMzjT04nTqkhwdq4w4Gu9RF3A4z19CGgVA8GHDTSZ/r45/SlCeT0kMzOe7pyVHdV+8cTKf++nx9fS1upl/DgilEE8ZucXcx/z/OiHPj8zKoPG5PaNufszPADCe++fxFTO+aCIvKfgGhG3rH9w0pqGxeU2Prsk/NLyxW6BhxMh4znN8/5mvm6eK5S1j89ICXnjyW6hfrH/biIH5N5O5qiZLrA4ynpdprSSzS0hcwoii8cPUwV0tVgcZzws1eXHJPfGeihtRML4nOXzlTBSN56s3PyPzLSTpdtgnI4LG88Hxc2oPQV3F7iDzf6BSYbad9suIkPluXT0bCeNzVYE3wY77Z3TQ+DyV58eJ1UHGd8NmCTSDzC4f5BoAYHwPdXDT7XxwcTKex5RbuvwKusDu+2uEaDw/b/ZzOxUxNjN/ojrdD3bKPhshmH+DOriBYnWQ8TlqbK5z2r4b7TDe1kVMnI3n1iyPqFO+I5fYG20Yn6ny2E8kz7ea52eoOijTycditGK8oUxn8zPE7iDzr1EznyFuOB7jHPOvVQc32GW+NUGnOmj8QHWt40Y3DUwAgHf2nxqSlOBZTmbrMbfF36A54wek7QvT+HSV5/kSbqLbBicAQKLX8zm577p9kTL+3TCN57qHb9b8mswuG26KKr8/cFzmnSiPx1XmV5K59iCvA+bz20B3kdlaxU3mN6ljyv7ewvwVIV0HcMjB/Q5aBOP/28Hv4s4ieW6rX6HZ4xbkfxbSdQCHxHv8Vw/j98g8JSgOQg/A+DdDug7gkCjmg4Pxb4nPQcGzHl6XsQrmN7T7OoBTihgyL8I8A/MbxOsWwc8e8ONoD8H44yFdB3BANEO8lv5hGH9CvA6K91We3x3SNNAhwX37ZsP4T8XnoDik8vyfwroOYPP4Erofxm8Un4OCW9PwcxZPwfy6cL7AzANyXj3sArYT59eJ1UJ5/GVoI44+1pAvMmx7cS9BDMP64eB0UW1WeH8k8by8AuIiZC+PXi89BwU8ScxuRJ2F8baS/PN4A1EBLoRUwv068DoqvoAUwvixaPxAvAPgUxt1AFsL4I+JzUHA3kVkwfnu0fyjmANQ3NpcYXs/Uawf23S4+B0WZyvMjmeZtAUDtmWbae7SGymrrB+A/n71vw5eznp7cb5t4bg4PmX2Hl8F4XyR/OOoANDX7qaS8NiD+rII7hGwFBNwhZB5AKNXY/MAYwPi4jEFUAfiysp728a+e//rPE9wbZxJA4OVoj4OAn0bG/1vN5+N6FozKs+knfY1UWFJJu0ur2zL/bHD3kIehAwBhKuT2R8qPktkaZ1S8zY84AHUwe+fh6oD5DEGIwU0h+TnkB4BgtAuNz2kuXbfvIP4pfk2sSryYpIDmPPL8iVpqbtnnw41RCgKGYT7SQpkLzF+n8vwhu+1Yh4FAVx+o7ttxqg81uKPmZIDAffSWA4Rah5q+S+X5f9p1B8NOAZWVjfSvg1X0cfvyfLjBnUMXQ/sBwhQH1Qd8E4tb5Iy0s/lhAcB5ftfh01RYXE0VNWditZ99IH5fQCEgGGnj8WxQ8/lsGP8S1Gx3UtudAjjPHyyvp+ITPmpsj1v9wh01twOCQCyeYtRGY8kLVnhVzhdOylHtAuBIFed5H/kamuywz5wG7oJuBgiB1TAAIR43knmJGl+3L3JiZdpm0j+1dIDTK9M2U8CpukbaijS/46vqu5hvjVQ1rdoHEG6Jw++XQ/dCI5xq/nnPAPWNzVR0zEelFXXkj/8xZPE0CxBwscX3F3ZH+fe48FkFPQrjq5w+PzVa5nmqL/5TSwc4zzf5nXYs/ObQnQAhsCYeIERjOdlf1J4/gC5JP4PwLFTDbTnSQ3V2O9UH2h9wE723AYTHVHAQiQdH+OnpOTD+PXJZBG6AT74+/cb2Q6caHG6+NdLIXEa1FyBM6sD3VJDZv2e4G80P/MX4MbzzeDyEgeInYrkDxk0uPEx+quQOnA3atYR689ICfkElv81kMYw/SS6PgPdnATgbACFfFTlDXXa8YwFAAEm0AKCA0A1SMxQS1xSqXYXJ3tHodABA0QdxsIVulhTMqVBoBYAGhCuJXm+WqKZCETgBYQCiGuNn9BDUXE9AJAPS9f1AvY5Bh1AwACwj7IO4wyiqSIdUMAAsIe6Bu+PhBGV7NALCAYJwF+LQeP0aqLEOsGQCW+uBpVR88R2bDRgmdALCAUAHx3ZRvQ5tkmDUDwALCHoibz3+fzGaOEjoBYAHhbTVbuJ/Mpo4SOgGgIGiA+P1BfH/heak0NAPAAgK3MucXMC2S0tAMAAsIn0L83lFeoPKgWKQZABYQGiDudsov9KyT+kAzACwg8MuseAbmeDJbtEjoGQCW+mCZqg+4e7RfrNEIAAsIx6Hpqj54X+zRDAALCLuhfDIXZh4SmzQDwAICdw7lV/IuJLMztoROACgI6iDuJsp//l8r9YFmAFhAOArdLZ/HkvkoW0InACwgcJv0MWS2mDssJmgGgIKgAeK3i/FlkWukPtAMAAsI3DZ9DJmt5g6LjZoBYAGBn8N4WNUnr4ulmgFgqQ9eV2mB04O8SEMnACwg+KBHVKG4Vq4ftB3/E2AAyyfy7j9njCYAAAAASUVORK5CYII=">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/github-dark.min.css" id="hljs-theme-dark">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/github.min.css" id="hljs-theme-light" disabled>
  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/highlight.min.js"></script>
  <style>
    :root {
      --bg-deep: #101114;
      --bg-surface: #16181c;
      --bg-elevated: #1e2025;
      --bg-hover: #282a30;
      --border: #363840;
      --text-primary: #f0f1f3;
      --text-secondary: #c2c4c9;
      --text-tertiary: #9a9da5;
      --text-muted: #7d808a;
      --accent: #E86F33;
      --accent-dim: rgba(232, 111, 51, 0.22);
      --accent-glow: rgba(232, 111, 51, 0.55);
      --success: #3ecf8e;
      --success-dim: rgba(62, 207, 142, 0.18);
      --warning: #f0b429;
      --warning-dim: rgba(240, 180, 41, 0.18);
      --team: #60a5fa;
      --team-dim: rgba(96, 165, 250, 0.18);
      --plan: #86a886;
      --plan-dim: rgba(134, 168, 134, 0.18);
      --mono: 'IBM Plex Mono', monospace;
      --serif: 'Playfair Display', serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--mono);
      font-size: 14px;
      background: var(--bg-deep);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* Subtle scan-line texture */
    body::before {
      display: none;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Layout */
    .app { display: flex; height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width, 300px);
      background: var(--bg-surface);
      border-right: 1px solid var(--border);
      box-shadow: 1px 0 12px rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
      transition: width 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sidebar.collapsed { width: 48px; }
    .sidebar.collapsed .logo-text,
    .sidebar.collapsed .connection,
    .sidebar.collapsed .sidebar-section,
    .sidebar.collapsed .sidebar-footer { display: none; }
    .sidebar.loading .sidebar-section,
    .sidebar.loading .sidebar-footer { display: none; }
    .sidebar.collapsed .sidebar-header {
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .sidebar.collapsed .sidebar-toggle-btn {
      position: static;
    }
    .sidebar.resizing { transition: none; }

    .sidebar-header {
      flex-shrink: 0;
      padding: 20px 20px 16px;
      border-bottom: none;
      background-image: linear-gradient(to right, transparent, var(--border), transparent);
      background-size: 100% 1px;
      background-repeat: no-repeat;
      background-position: bottom;
      position: relative;
    }

    .sidebar-toggle-btn {
      position: absolute;
      top: 20px;
      right: 8px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
      padding: 0;
    }

    .sidebar-toggle-btn:hover {
      color: var(--text-secondary);
      background: var(--bg-hover);
      border-color: var(--border);
    }

    .sidebar-toggle-btn svg {
      width: 16px;
      height: 16px;
      transition: transform 0.25s ease;
    }

    .sidebar.collapsed .sidebar-toggle-btn svg {
      transform: rotate(180deg);
    }

    .sidebar-resize-handle {
      position: absolute;
      top: 0;
      right: 0;
      width: 4px;
      height: 100%;
      cursor: col-resize;
      z-index: 10;
      transition: background 0.15s;
    }

    .sidebar-resize-handle:hover,
    .sidebar-resize-handle.dragging {
      background: var(--accent-dim);
    }

    .sidebar.collapsed .sidebar-resize-handle { display: none; }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-text {
      font-family: var(--serif);
      font-size: 17px;
      font-weight: 500;
      letter-spacing: -0.02em;
    }

    .connection {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 10px;
      font-size: 10px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .connection-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--warning);
    }

    .connection-dot.live {
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
    }

    .connection-dot.error {
      background: #ef4444;
    }

    /* Sidebar sections */
    .sidebar-section {
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      border-bottom: none;
      background-image: linear-gradient(to right, transparent, var(--border), transparent);
      background-size: 100% 1px;
      background-repeat: no-repeat;
      background-position: bottom;
    }

    .sidebar-section.flex-1 {
      flex: 1;
      border-bottom: none;
      overflow: hidden;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px 10px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .filter-row {
      display: flex;
      gap: 6px;
      padding: 0 16px 10px;
    }

    .reset-btn {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
    }

    .filter-dropdown {
      flex: 1;
      appearance: none;
      background: var(--bg-deep);
      border: 1px solid transparent;
      border-radius: 6px;
      padding: 7px 26px 7px 10px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%238b8d95' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      text-overflow: ellipsis;
      min-width: 0;
      transition: all 0.15s ease;
    }

    .filter-dropdown:hover {
      border-color: var(--border);
    }

    .filter-dropdown option {
      background: var(--bg-surface);
      color: var(--text-primary);
    }

    .filter-dropdown:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }

    /* Live Updates */
    .live-updates {
      padding: 0 16px 12px;
      max-height: 180px;
      overflow-y: auto;
    }

    .live-empty {
      padding: 16px;
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
    }

    .live-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-deep);
      border: 1px solid transparent;
      border-radius: 8px;
      margin-bottom: 4px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .live-item:hover {
      background: var(--bg-hover);
    }

    .live-item .pulse {
      width: 8px;
      height: 8px;
      margin-top: 4px;
      background: var(--accent);
      border-radius: 50%;
      flex-shrink: 0;
      animation: pulse 2s ease-in-out infinite;
      box-shadow: 0 0 12px var(--accent-glow);
    }

    .live-item-content {
      flex: 1;
      min-width: 0;
    }

    .live-item-action {
      font-size: 13px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .live-item-session {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Sessions */
    .sessions-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 14px 12px;
    }

    .session-item {
      display: block;
      width: 100%;
      padding: 12px 14px;
      margin-bottom: 2px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 8px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .session-item:hover {
      background: var(--bg-hover);
    }

    .session-item.active {
      background: var(--bg-elevated);
      border-color: var(--border);
    }

    .session-name {
      font-size: 14px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-indicators .pulse {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
      box-shadow: 0 0 12px var(--accent-glow);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.9); }
    }

    .session-secondary {
      font-size: 12px;
      font-weight: 450;
      color: var(--text-tertiary);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
    }

    .session-branch {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
      display: block;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0.7;
    }

    .session-project {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      direction: rtl;
      text-align: left;
    }

    .session-project-actions {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    .session-project-btn {
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.15s ease;
    }

    .session-project-btn[data-action="copyPath"] {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .session-project-btn[data-action="copyPath"]:hover {
      border-color: var(--accent);
    }

    .session-project-btn[data-action="openFolder"] {
      background: var(--warning-dim);
      color: var(--warning);
    }

    .session-project-btn[data-action="openFolder"]:hover {
      border-color: var(--warning);
    }

    .session-plan {
      font-size: 10px;
      color: var(--plan);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-progress {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }

    .progress-bar {
      flex: 1;
      min-width: 30px;
      height: 2px;
      background: var(--border);
      border-radius: 1px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.5s ease-out;
    }

    .progress-text {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-tertiary);
      font-variant-numeric: tabular-nums;
    }

    .session-time {
      font-size: 11px;
      font-weight: 450;
      color: var(--text-tertiary);
      margin-top: 6px;
    }

    /* Footer */
    .sidebar-footer {
      flex-shrink: 0;
      padding: 14px 20px;
      border-top: none;
      background-image: linear-gradient(to right, transparent, var(--border), transparent);
      background-size: 100% 1px;
      background-repeat: no-repeat;
      background-position: top;
      font-size: 10px;
      color: var(--text-muted);
    }

    .sidebar-footer a {
      color: var(--text-tertiary);
      text-decoration: none;
      transition: color 0.15s;
    }

    .sidebar-footer a:hover {
      color: var(--text-secondary);
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg-deep);
    }

    /* Empty state */
    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 13px;
    }

    .loading-spinner {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      color: var(--text-muted);
    }

    .loading-spinner .spinner {
      width: 28px;
      height: 28px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Session view */
    .session-view {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .session-view.visible {
      display: flex;
    }

    /* Header */
    .view-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-surface);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .view-title {
      font-family: var(--serif);
      font-size: 26px;
      font-weight: 400;
      letter-spacing: -0.03em;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .view-meta {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .view-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .view-progress {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .view-progress .progress-bar {
      width: 120px;
      height: 3px;
    }

    .view-progress .progress-text {
      font-size: 14px;
      font-weight: 500;
      color: var(--accent);
    }

    .icon-btn {
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-tertiary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .icon-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--text-muted);
    }

    .icon-btn svg {
      width: 16px;
      height: 16px;
    }

    .icon-btn.notifications-active {
      color: var(--accent);
      border-color: var(--accent);
      background: var(--accent-dim);
    }

    /* View toggle */
    .view-toggle {
      display: flex;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }

    .view-toggle-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 5px 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: all 0.15s;
    }

    .view-toggle-btn:hover {
      color: var(--text-secondary);
      background: var(--bg-hover);
    }

    .view-toggle-btn.active {
      color: var(--accent);
      background: var(--accent-dim);
    }

    .view-toggle-btn svg {
      width: 16px;
      height: 16px;
    }

    .view-toggle-btn + .view-toggle-btn {
      border-left: 1px solid var(--border);
    }

    .icon-btn-danger {
      color: #ef4444;
    }

    .icon-btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border-color: #ef4444;
    }

    /* Kanban */
    .kanban {
      flex: 1;
      display: flex;
      gap: 24px;
      padding: 24px;
      overflow-x: auto;
    }

    .kanban-column {
      flex: 1;
      min-width: 280px;
      max-width: 400px;
      display: flex;
      flex-direction: column;
    }

    .column-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 20px;
      border-bottom: none;
      margin-bottom: 16px;
      background-image: linear-gradient(to bottom, transparent 80%, var(--border) 100%);
      background-size: 100% 1px;
      background-repeat: no-repeat;
      background-position: bottom;
    }

    .column-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .column-dot.pending { background: var(--text-tertiary); }
    .column-dot.in-progress {
      background: var(--accent);
      box-shadow: 0 0 12px var(--accent-glow);
      animation: pulse 2s ease-in-out infinite;
    }
    .column-dot.completed { background: var(--success); }

    .column-title {
      font-size: 14px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .column-title.pending { color: var(--text-tertiary); }
    .column-title.in-progress { color: var(--accent); }
    .column-title.completed { color: var(--success); }

    .column-count {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      font-variant-numeric: tabular-nums;
    }

    .column-count.pending {
      background: var(--bg-elevated);
      color: var(--text-tertiary);
    }

    .column-count.in-progress {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .column-count.completed {
      background: var(--success-dim);
      color: var(--success);
    }

    .column-tasks {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-right: 8px;
    }

    .column-empty {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-muted);
      font-size: 12px;
      border: 1px dashed var(--border);
      border-radius: 8px;
      margin-top: 4px;
    }

    .column-empty svg {
      width: 24px;
      height: 24px;
      opacity: 0.5;
      margin-bottom: 8px;
    }

    /* Task card */
    .task-card {
      padding: 16px;
      padding-left: 18px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-left: 2px solid var(--text-muted);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .task-card:hover {
      background: var(--bg-hover);
      border-color: var(--text-muted);
      border-left-color: var(--text-muted);
    }

    .task-card:focus-visible {
      outline: none;
    }

    .task-card.in-progress {
      border-left: 2px solid var(--accent);
    }

    .task-card.completed {
      opacity: 0.85;
      border-left: 2px solid var(--success);
    }

    .task-card.completed:hover {
      border-left-color: var(--success);
    }

    .task-card.blocked {
      opacity: 0.7;
    }

    .task-card.selected,
    .task-card.selected:hover {
      background: var(--bg-elevated);
      border-color: var(--team);
      border-left: 2px solid var(--team);
      box-shadow: 0 0 0 1px var(--team-dim), 0 0 12px var(--team-dim);
      opacity: 1;
    }

    .task-id {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .task-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .task-badge.blocked {
      background: rgba(220, 80, 30, 0.15);
      color: #dc4e1e;
    }

    .task-title {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.4;
    }

    .task-card.completed .task-title {
      text-decoration: line-through;
      color: var(--text-tertiary);
    }

    .task-session {
      font-size: 12px;
      color: var(--accent);
      margin-top: 6px;
    }

    .task-active {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      font-size: 11px;
      font-weight: 500;
      color: var(--accent);
    }

    .task-active::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    .task-blocked {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .task-desc {
      font-size: 12px;
      font-weight: 450;
      color: var(--text-tertiary);
      margin-top: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Detail panel */
    .detail-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 440px;
      height: 100vh;
      background: var(--bg-surface);
      border-left: 1px solid var(--border);
      box-shadow: -8px 0 24px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      display: none;
      z-index: 100;
      overflow: hidden;
    }

    .detail-panel.visible {
      display: flex;
    }

    .detail-header {
      padding: 16px 20px;
      border-bottom: none;
      background-image: linear-gradient(to right, transparent, var(--border), transparent);
      background-size: 100% 1px;
      background-repeat: no-repeat;
      background-position: bottom;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .detail-header h3 {
      font-family: var(--serif);
      font-size: 14px;
      font-weight: 500;
    }

    .detail-close {
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s;
    }

    .detail-close:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .detail-close svg {
      width: 20px;
      height: 20px;
    }

    .detail-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .detail-section {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: none;
      background-image: linear-gradient(to right, transparent, var(--border), transparent);
      background-size: 100% 1px;
      background-repeat: no-repeat;
      background-position: bottom;
    }

    .detail-section:last-child {
      background-image: none;
    }

    .detail-label {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .detail-title {
      font-family: var(--serif);
      font-size: 22px;
      line-height: 1.4;
      cursor: pointer;
      padding: 2px 4px;
      margin: -2px -4px;
      border-radius: 4px;
      border: 1px solid transparent;
      transition: border-color 0.15s ease;
    }

    .detail-title:hover {
      border-color: var(--border);
    }

    .detail-title-input {
      font-family: var(--serif);
      font-size: 22px;
      line-height: 1.4;
      width: 100%;
      padding: 2px 4px;
      margin: -2px -4px;
      background: var(--bg-elevated);
      border: 1px solid var(--accent);
      border-radius: 4px;
      color: var(--text-primary);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }

    .detail-title-input:focus {
      outline: none;
    }

    .detail-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .detail-status.pending {
      background: var(--bg-elevated);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .detail-status.in_progress {
      background: var(--accent-dim);
      color: var(--accent);
      border: 1px solid var(--accent);
    }

    .detail-status.completed {
      background: var(--success-dim);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .detail-status .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .detail-status.in_progress .dot {
      animation: pulse 2s ease-in-out infinite;
    }

    .detail-box {
      padding: 12px;
      border-radius: 6px;
      font-size: 12px;
    }

    .detail-box.active {
      background: rgba(232, 111, 51, 0.08);
      border: 1px solid rgba(232, 111, 51, 0.2);
      color: var(--text-primary);
    }

    .detail-box.active strong {
      color: var(--accent);
    }

    .detail-box.blocked {
      background: var(--warning-dim);
      border: 1px solid rgba(240, 180, 41, 0.35);
      color: var(--warning);
    }

    .detail-box.blocks {
      background: var(--team-dim);
      border: 1px solid rgba(96, 165, 250, 0.35);
      color: var(--team);
    }

    .detail-desc {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px 6px;
      margin: -4px -6px;
      border-radius: 4px;
      border: 1px solid transparent;
      transition: border-color 0.15s ease;
    }

    .detail-desc:hover {
      border-color: var(--border);
    }

    .detail-desc-textarea {
      width: 100%;
      min-height: 120px;
      padding: 8px 10px;
      margin: -4px -6px;
      background: var(--bg-elevated);
      border: 1px solid var(--accent);
      border-radius: 4px;
      color: var(--text-primary);
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.6;
      resize: vertical;
      box-shadow: 0 0 0 2px var(--accent-dim);
    }

    .detail-desc-textarea:focus {
      outline: none;
    }

    .edit-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 8px;
    }

    .edit-actions button {
      padding: 6px 14px;
      border: none;
      border-radius: 4px;
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .edit-save {
      background: var(--accent);
      color: white;
    }

    .edit-save:hover {
      filter: brightness(1.1);
    }

    .edit-cancel {
      background: var(--bg-elevated);
      color: var(--text-secondary);
      border: 1px solid var(--border) !important;
    }

    .edit-cancel:hover {
      color: var(--text-primary);
    }

    .detail-deps {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-secondary);
    }

    .detail-desc pre {
      border-radius: 6px;
      overflow: hidden;
      margin: 12px 0;
      font-size: 12px;
    }

    .detail-desc pre code.hljs {
      padding: 12px;
      border-radius: 6px;
    }

    .detail-desc pre code {
      background: var(--bg-elevated);
      padding: 12px;
      border-radius: 6px;
      display: block;
      overflow-x: auto;
    }

    .detail-desc code {
      background: var(--bg-elevated);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
    }

    .detail-desc hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 16px 0;
    }

    .detail-desc h4 {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent);
      margin: 0 0 8px 0;
    }

    .detail-desc p {
      margin: 0 0 12px 0;
    }

    .detail-desc p:last-child {
      margin-bottom: 0;
    }

    .detail-desc ol,
    .detail-desc ul {
      padding-left: 1.5em;
      margin: 0 0 12px 0;
    }

    .detail-desc ol:last-child,
    .detail-desc ul:last-child {
      margin-bottom: 0;
    }

    /* Note form */
    .note-section {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .note-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .note-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.5;
      resize: vertical;
      min-height: 60px;
    }

    .note-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }

    .note-input::placeholder {
      color: var(--text-muted);
    }

    .note-submit {
      align-self: flex-end;
      padding: 8px 16px;
      background: var(--accent);
      border: none;
      border-radius: 5px;
      color: white;
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .note-submit:hover {
      filter: brightness(1.1);
    }

    /* Team badge */
    .session-indicators {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    .team-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .team-badge .member-count {
      font-weight: 600;
    }

    .team-info-btn {
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-deep);
      border: 1px solid transparent;
      border-radius: 4px;
      color: var(--team);
      cursor: pointer;
      font-size: 11px;
      flex-shrink: 0;
      transition: all 0.15s ease;
    }

    .team-info-btn:hover {
      background: var(--team-dim);
      border-color: var(--team);
    }

    .completed-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 1px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 500;
      background: var(--success-dim);
      color: var(--success);
      white-space: nowrap;
    }

    .subagent-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 1px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 500;
      background: var(--accent-dim);
      color: var(--accent);
      white-space: nowrap;
    }

    .subagent-badge svg {
      flex-shrink: 0;
    }

    .subagent-section {
      border-top: 1px solid var(--border);
      padding: 16px 20px;
      margin-top: 8px;
    }

    .subagent-header {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      padding: 4px 0;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .subagent-header:hover {
      color: var(--text-primary);
    }

    .subagent-header .toggle-icon {
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }

    .subagent-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .subagent-count {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
    }

    .subagent-filter {
      margin-left: auto;
      font-size: 10px;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0;
      color: var(--accent);
      cursor: pointer;
    }

    .subagent-filter:hover {
      text-decoration: underline;
    }

    .subagent-cards {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
    }

    .subagent-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      transition: border-color 0.15s ease;
    }

    .subagent-card:hover {
      border-color: var(--text-muted);
    }

    .subagent-card.active {
      border-color: var(--accent);
      border-left-width: 3px;
    }

    .subagent-detail {
      display: none;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-secondary);
      flex-direction: column;
      gap: 4px;
    }

    .subagent-card.expanded .subagent-detail {
      display: flex;
    }

    .subagent-detail-row {
      display: flex;
      gap: 6px;
    }

    .subagent-detail-label {
      color: var(--text-muted);
      min-width: 50px;
      flex-shrink: 0;
    }

    .subagent-detail-value {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .subagent-card-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .subagent-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
      flex-shrink: 0;
    }

    .subagent-status-dot.active {
      background: var(--success);
      box-shadow: 0 0 4px var(--success);
    }

    .subagent-model {
      font-size: 10px;
      padding: 1px 5px;
      border-radius: 3px;
      background: var(--bg-hover);
      color: var(--text-tertiary);
      margin-left: auto;
    }

    .subagent-desc {
      font-size: 11px;
      color: var(--text-tertiary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .subagent-time {
      font-size: 10px;
      color: var(--text-muted);
    }

    .plan-indicator {
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--plan-dim);
      border: 1px solid transparent;
      border-radius: 4px;
      color: var(--plan);
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.15s ease;
    }

    .plan-indicator:hover {
      background: var(--plan-dim);
      border-color: var(--plan);
    }

    /* Task owner badge */
    .task-owner-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 500;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: none;
      letter-spacing: 0;
    }

    /* Team modal member card */
    .team-member-card {
      padding: 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .team-member-card .member-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .team-member-card .member-detail {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .team-member-card .member-tasks {
      font-size: 11px;
      color: var(--accent);
      margin-top: 4px;
    }

    .team-modal-desc {
      font-size: 12px;
      color: var(--text-secondary);
      font-style: italic;
      margin-bottom: 16px;
    }

    .team-modal-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    /* Owner filter â€” overlaid, zero layout impact */
    .kanban {
      position: relative;
    }

    .owner-filter-bar {
      display: none;
      position: absolute;
      top: 24px;
      right: 24px;
      z-index: 2;
    }

    .owner-filter-bar.visible {
      display: flex;
      align-items: center;
    }

    .owner-filter-bar .filter-dropdown {
      flex: none;
      width: auto;
      max-width: 180px;
      font-size: 13px;
      padding: 6px 10px;
    }

    /* Light mode */
    body.light {
      --bg-deep: #e8e6e3;
      --bg-surface: #f4f3f1;
      --bg-elevated: #dddbd8;
      --bg-hover: #d2d0cc;
      --border: #a09b94;
      --text-primary: #0a0a0a;
      --text-secondary: #444444;
      --text-tertiary: #666666;
      --text-muted: #888888;
      --accent-dim: rgba(232, 111, 51, 0.18);
      --accent-glow: rgba(232, 111, 51, 0.5);
      --success: #1a8a5a;
      --success-dim: rgba(26, 138, 90, 0.15);
      --warning: #b07d0a;
      --warning-dim: rgba(176, 125, 10, 0.15);
      --plan: #5a7a5a;
      --plan-dim: rgba(90, 122, 90, 0.15);
    }

    body.light::before {
      display: none;
    }

    /* Interactive elements */
    .icon-btn.delete:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
    }

    .column-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .column-header .icon-btn {
      width: 28px;
      height: 28px;
    }

    .column-header .icon-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Search input */
    .search-container {
      position: relative;
      padding: 0 16px 8px;
    }

    .search-input {
      width: 100%;
      padding: 9px 32px 9px 12px;
      background: var(--bg-deep);
      border: 1px solid transparent;
      border-radius: 6px;
      color: var(--text-primary);
      font-family: var(--mono);
      font-size: 13px;
      transition: all 0.15s ease;
    }

    .search-input:hover {
      border-color: var(--border);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-clear {
      position: absolute;
      right: 18px;
      top: 8px;
      width: 20px;
      height: 20px;
      background: none;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0;
      border-radius: 3px;
    }

    .search-clear:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .search-clear.visible {
      display: flex;
    }

    /* Reconnection overlay */
    #reconnect-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      backdrop-filter: blur(2px);
    }

    #reconnect-overlay.visible {
      display: flex;
    }

    .reconnect-box {
      text-align: center;
      padding: 32px 48px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .reconnect-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      margin: 0 auto 16px;
      animation: reconnect-spin 0.8s linear infinite;
    }

    @keyframes reconnect-spin {
      to { transform: rotate(360deg); }
    }

    .reconnect-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .reconnect-message {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .reconnect-attempt {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .plan-modal-overlay {
      z-index: 10001;
      background: rgba(0, 0, 0, 0.6);
    }

    .modal.plan-modal {
      width: 60vw;
      max-width: 60vw;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .modal {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.15s ease;
    }

    .modal-close:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .modal-body {
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: var(--mono);
      font-size: 14px;
      transition: all 0.15s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    textarea.form-input {
      resize: vertical;
      min-height: 80px;
      font-family: var(--mono);
    }

    select.form-input[multiple] {
      padding: 4px;
    }

    select.form-input optgroup {
      background: var(--bg-surface);
      color: var(--accent);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 8px 8px 4px 8px;
      margin-top: 4px;
      font-style: normal;
    }

    select.form-input optgroup:first-child {
      margin-top: 0;
    }

    select.form-input option {
      padding: 8px 8px 8px 16px;
      background: var(--bg-elevated);
      color: var(--text-primary);
      font-weight: 400;
      font-size: 13px;
      border-radius: 4px;
      margin: 2px 4px;
    }

    select.form-input option:checked {
      background: var(--accent);
      color: var(--bg-deep);
      font-weight: 500;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-family: var(--mono);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: #d96329;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--text-muted);
    }

    .btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Skip navigation */
    .skip-link {
      position: absolute;
      top: -100%;
      left: 16px;
      z-index: 100000;
      padding: 8px 16px;
      background: var(--accent);
      color: white;
      font-size: 13px;
      border-radius: 0 0 6px 6px;
      text-decoration: none;
      transition: top 0.2s;
    }

    .skip-link:focus {
      top: 0;
    }

    /* Visually hidden (a11y) */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* System theme detection */
    @media (prefers-color-scheme: light) {
      body:not(.dark-forced) {
        --bg-deep: #e8e6e3;
        --bg-surface: #f4f3f1;
        --bg-elevated: #dddbd8;
        --bg-hover: #d2d0cc;
        --border: #a09b94;
        --text-primary: #0a0a0a;
        --text-secondary: #444444;
        --text-tertiary: #666666;
        --text-muted: #888888;
        --accent-dim: rgba(232, 111, 51, 0.18);
        --accent-glow: rgba(232, 111, 51, 0.5);
        --success: #1a8a5a;
        --success-dim: rgba(26, 138, 90, 0.15);
        --warning: #b07d0a;
        --warning-dim: rgba(176, 125, 10, 0.15);
        --plan: #5a7a5a;
        --plan-dim: rgba(90, 122, 90, 0.15);
      }

      body:not(.dark-forced)::before {
        display: none;
      }
    }

    /* Card entrance animation */
    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .column-tasks .task-card {
      animation: fadeSlideIn 150ms ease-out both;
    }

    .column-tasks .task-card:nth-child(1) { animation-delay: 0ms; }
    .column-tasks .task-card:nth-child(2) { animation-delay: 30ms; }
    .column-tasks .task-card:nth-child(3) { animation-delay: 60ms; }
    .column-tasks .task-card:nth-child(4) { animation-delay: 90ms; }
    .column-tasks .task-card:nth-child(5) { animation-delay: 120ms; }
    .column-tasks .task-card:nth-child(6) { animation-delay: 150ms; }
    .column-tasks .task-card:nth-child(7) { animation-delay: 180ms; }
    .column-tasks .task-card:nth-child(8) { animation-delay: 210ms; }
    .column-tasks .task-card:nth-child(9) { animation-delay: 240ms; }
    .column-tasks .task-card:nth-child(10) { animation-delay: 270ms; }

    /* Connection status breathing */
    @keyframes breathe {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.65; }
    }

    .connection-dot.live {
      animation: breathe 3s ease-in-out infinite;
    }

    /* Progress bar shimmer */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .progress-fill.shimmer {
      background: linear-gradient(90deg, var(--accent) 0%, rgba(232,111,51,0.75) 50%, var(--accent) 100%);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }

    /* Session list hover accent bar */
    .session-item {
      position: relative;
    }

    .session-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 60%;
      background: var(--accent);
      border-radius: 0 2px 2px 0;
      transition: width 0.15s ease;
    }

    .session-item:hover::before {
      width: 0;
    }

    .sidebar-focused .session-item.active {
      background: transparent;
      border-color: transparent;
    }

    .sidebar-focused .session-item.active::before {
      width: 0;
    }

    .session-item.kb-selected,
    .session-item.kb-selected:hover,
    .session-item.active.kb-selected {
      background: var(--bg-elevated);
      border-color: var(--team);
      box-shadow: 0 0 0 1px var(--team-dim);
    }

    .session-item.kb-selected::before {
      width: 0;
    }

    /* Archived sessions */
    .archived-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      margin-top: 8px;
      cursor: pointer;
      font-size: 11px;
      color: var(--text-muted);
      border-top: 1px solid var(--border);
      transition: color 0.15s;
      user-select: none;
    }

    .archived-header:hover {
      color: var(--text-secondary);
    }

    .archived-header svg {
      width: 14px;
      height: 14px;
      transition: transform 0.2s;
    }

    .archived-header.expanded svg {
      transform: rotate(90deg);
    }

    .archived-sessions {
      display: none;
    }

    .archived-sessions.visible {
      display: block;
    }

    .session-item.archived {
      opacity: 0.5;
    }

    /* Timeline view */
    .timeline {
      display: none;
      flex-direction: column;
      gap: 2px;
      padding: 20px;
      overflow-y: auto;
      height: calc(100vh - 140px);
    }

    .timeline.visible {
      display: flex;
    }

    .timeline-axis {
      display: flex;
      justify-content: space-between;
      padding: 0 140px 8px 140px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }

    .timeline-axis-label {
      font-size: 10px;
      color: var(--text-muted);
      font-family: var(--mono);
    }

    .timeline-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      border-radius: 4px;
      transition: background 0.15s;
    }

    .timeline-row:hover {
      background: var(--bg-hover);
    }

    .timeline-label {
      width: 130px;
      flex-shrink: 0;
      font-size: 11px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: right;
      padding-right: 8px;
    }

    .timeline-bar-container {
      flex: 1;
      height: 20px;
      position: relative;
      background: var(--bg-elevated);
      border-radius: 3px;
      overflow: hidden;
    }

    .timeline-bar {
      position: absolute;
      height: 100%;
      border-radius: 3px;
      min-width: 3px;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .timeline-bar:hover {
      opacity: 0.85;
    }

    .timeline-bar.pending {
      background: var(--text-muted);
    }

    .timeline-bar.in-progress {
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent-glow);
    }

    .timeline-bar.completed {
      background: var(--success);
    }

    .timeline-tooltip {
      display: none;
      position: fixed;
      z-index: 1000;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .timeline-tooltip.visible {
      display: block;
    }

    .timeline-tooltip-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .timeline-tooltip-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .timeline-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: var(--text-muted);
      font-size: 13px;
      gap: 8px;
    }

    .timeline-empty svg {
      width: 32px;
      height: 32px;
      opacity: 0.4;
    }

    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 10000;
    }

    #toast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar loading">
      <header class="sidebar-header">
        <div class="logo">
          <div class="logo-mark">
            <img src="images/icon.png" alt="ATC" style="width:100%;height:100%;object-fit:contain;">
          </div>
          <span class="logo-text">ATC Claude Kanban</span>
        </div>
        <div id="connection-status" class="connection">
          <span class="connection-dot"></span>
          <span>Connecting</span>
        </div>
        <button id="sidebar-toggle" class="sidebar-toggle-btn" data-action="toggleSidebar" title="Toggle sidebar" aria-label="Toggle sidebar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
      </header>

      <!-- Live Updates (hidden until active tasks exist) -->
      <div id="live-updates-section" class="sidebar-section" style="display: none;">
        <div class="section-header">
          <span>Live Updates</span>
        </div>
        <div id="live-updates" class="live-updates"></div>
      </div>

      <!-- Tasks -->
      <div class="sidebar-section flex-1">
        <div class="section-header">
          <span>Sessions</span>
          <button data-action="showAllTasks" style="background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 4px; padding: 3px 8px; font-size: 10px; color: var(--text-secondary); cursor: pointer; font-family: var(--mono);">All Tasks</button>
        </div>
        <div class="search-container">
          <input
            id="search-input"
            type="text"
            class="search-input"
            placeholder="Search tasks, sessions, projects..."
          />
          <button id="search-clear-btn" class="search-clear" data-action="clearSearch" title="Clear search" aria-label="Clear search">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="filter-row">
          <select id="project-filter" class="filter-dropdown" aria-label="Filter by project">
            <option value="">All Projects</option>
          </select>
          <select id="session-filter" class="filter-dropdown" aria-label="Filter by session status">
            <option value="all">All Sessions</option>
            <option value="active">Active Only</option>
          </select>
        </div>
        <div class="filter-row">
          <select id="session-limit" class="filter-dropdown" aria-label="Number of sessions to show">
            <option value="10">Show 10</option>
            <option value="20">Show 20</option>
            <option value="50">Show 50</option>
            <option value="all">Show All</option>
          </select>
          <button class="icon-btn reset-btn" data-action="resetState" title="Reset all filters" aria-label="Reset all filters">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <path d="M3 12a9 9 0 1 1 9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
              <path d="M3 22v-6h6"/>
            </svg>
          </button>
        </div>
        <div id="sessions-list" class="sessions-list"></div>
      </div>

      <div class="sidebar-footer" id="sidebar-footer"></div>
      <div class="sidebar-resize-handle" id="sidebar-resize"></div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div id="loading-state" class="loading-spinner">
        <div class="spinner"></div>
      </div>
      <div id="no-session" class="empty-state" style="display: none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
        <p>Select a session to view tasks</p>
      </div>

      <div id="session-view" class="session-view">
        <header class="view-header">
          <div>
            <h1 id="session-title" class="view-title">Session</h1>
            <p id="session-meta" class="view-meta"></p>
          </div>
          <div class="view-actions">
            <div class="view-progress">
              <div class="progress-bar">
                <div id="progress-bar" class="progress-fill" style="width: 0%"></div>
              </div>
              <span id="progress-percent" class="progress-text">0%</span>
            </div>
            <div class="view-toggle">
              <button id="view-kanban-btn" class="view-toggle-btn active" data-action="switchToKanban" title="Kanban view" aria-label="Kanban view">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="5" height="18" rx="1"/>
                  <rect x="10" y="3" width="5" height="12" rx="1"/>
                  <rect x="17" y="3" width="5" height="15" rx="1"/>
                </svg>
              </button>
              <button id="view-timeline-btn" class="view-toggle-btn" data-action="switchToTimeline" title="Timeline view" aria-label="Timeline view">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18M3 12h12M3 18h16"/>
                </svg>
              </button>
            </div>
            <button id="notifications-toggle" class="icon-btn" data-action="toggleNotifications" title="Notifications off (click to enable)" aria-label="Toggle notifications">
              <svg id="bell-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0"/>
              </svg>
            </button>
            <button id="theme-toggle" class="icon-btn" data-action="toggleTheme" title="Toggle theme" aria-label="Toggle theme">
              <svg id="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
              </svg>
              <svg id="theme-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
                <circle cx="12" cy="12" r="5"/>
                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
              </svg>
            </button>
            <button class="icon-btn" data-action="showHelpModal" title="Keyboard shortcuts (?)" aria-label="Keyboard shortcuts">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                <circle cx="12" cy="17" r="0.5" fill="currentColor"/>
              </svg>
            </button>
            <a href="https://github.com/atc-net/atc-claude-kanban" target="_blank" class="icon-btn" title="View on GitHub" aria-label="View on GitHub">
              <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
              </svg>
            </a>
          </div>
        </header>

        <div class="kanban" id="main-content">
          <div id="owner-filter-bar" class="owner-filter-bar">
            <select id="owner-filter" class="filter-dropdown" onchange="filterByOwner(this.value)" aria-label="Filter by team member">
              <option value="">All Members</option>
            </select>
          </div>
          <div class="kanban-column" aria-label="Pending tasks">
            <div class="column-header">
              <span class="column-dot pending"></span>
              <span class="column-title pending">Pending</span>
              <span id="pending-count" class="column-count pending">0</span>
            </div>
            <div id="pending-tasks" class="column-tasks" role="list"></div>
          </div>

          <div class="kanban-column" aria-label="In progress tasks">
            <div class="column-header">
              <span class="column-dot in-progress"></span>
              <span class="column-title in-progress">In Progress</span>
              <span id="in-progress-count" class="column-count in-progress">0</span>
            </div>
            <div id="in-progress-tasks" class="column-tasks" role="list"></div>
          </div>

          <div class="kanban-column" aria-label="Completed tasks">
            <div class="column-header">
              <span class="column-dot completed"></span>
              <span class="column-title completed">Completed</span>
              <span id="completed-count" class="column-count completed">0</span>
            </div>
            <div id="completed-tasks" class="column-tasks" role="list"></div>
          </div>
        </div>
        <div id="timeline-view" class="timeline">
          <div id="timeline-axis" class="timeline-axis"></div>
          <div id="timeline-rows"></div>
        </div>
        <div id="timeline-tooltip" class="timeline-tooltip">
          <div id="tooltip-title" class="timeline-tooltip-title"></div>
          <div id="tooltip-time" class="timeline-tooltip-time"></div>
        </div>
        <div id="subagent-section" class="subagent-section" style="display: none;">
          <div class="subagent-header" data-action="toggleSubagents">
            <svg class="toggle-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            <span>Subagents</span>
            <span id="subagent-count" class="subagent-count">0</span>
            <span id="subagent-filter-toggle" class="subagent-filter" data-action="toggleSubagentFilter">Show all</span>
          </div>
          <div id="subagent-cards" class="subagent-cards"></div>
        </div>
      </div>
    </main>

    <!-- Detail panel -->
    <aside id="detail-panel" class="detail-panel">
      <header class="detail-header">
        <h3>Task Details</h3>
        <div style="display: flex; gap: 8px; align-items: center;">
          <button id="delete-task-btn" class="icon-btn" title="Delete task (D)" aria-label="Delete task" style="color: #ef4444; border-color: #ef4444; display: none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            </svg>
          </button>
          <button id="close-detail" class="detail-close" aria-label="Close detail panel">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      </header>
      <div id="detail-content" class="detail-content"></div>
    </aside>
  </div>

  <script>
    const isDebug = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const log = {
      debug: isDebug ? console.log.bind(console) : () => {},
      error: console.error.bind(console),
    };

    // State
    let sessions = [];
    let currentSessionId = null;
    let currentTasks = [];
    let viewMode = 'session';
    let sessionFilter = 'active';
    let sessionLimit = '20';
    let filterProject = ''; // '' = all, '__recent__' = last 24h, or project path
    let recentProjects = new Set();
    let searchQuery = ''; // Search query for fuzzy search
    let allTasksCache = []; // Cache all tasks for search
    let notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
    let previousTaskStatuses = new Map();
    const ARCHIVE_DAYS = 7;
    let archivedExpanded = localStorage.getItem('archivedExpanded') === 'true';
    let currentView = localStorage.getItem('currentView') || 'kanban';
    let bulkDeleteSessionId = null; // Track session for bulk delete
    let ownerFilter = '';
    let selectedTaskId = null;
    let selectedSessionId = null;
    let focusZone = 'board'; // 'board' | 'sidebar'
    let selectedSessionIdx = -1;
    let currentSubagents = [];
    let showAllSubagents = false;
    const knownSessions = new Map(); // client-side persistence until page refresh
    const completedTasksCache = []; // tasks preserved from sessions that completed

    function getUrlState() {
      const params = new URLSearchParams(window.location.search);
      return {
        session: params.get('session'),
        view: params.get('view'),
        filter: params.get('filter'),
        limit: params.get('limit'),
        project: params.get('project'),
        owner: params.get('owner'),
        search: params.get('search'),
      };
    }

    function updateUrl() {
      const params = new URLSearchParams();
      if (viewMode === 'all') params.set('view', 'all');
      if (currentSessionId) params.set('session', currentSessionId);
      if (sessionFilter !== 'active') params.set('filter', sessionFilter);
      if (sessionLimit !== '20') params.set('limit', sessionLimit);
      if (filterProject) params.set('project', filterProject);
      if (ownerFilter) params.set('owner', ownerFilter);
      if (searchQuery) params.set('search', searchQuery);
      const qs = params.toString();
      const url = qs ? `?${qs}` : window.location.pathname;
      history.replaceState(null, '', url);
    }

    function resetState() {
      history.replaceState(null, '', window.location.pathname);
      sessionFilter = 'active';
      sessionLimit = '20';
      filterProject = '';
      ownerFilter = '';
      searchQuery = '';
      viewMode = 'all';
      currentSessionId = null;
      const searchInput = document.getElementById('search-input');
      if (searchInput) searchInput.value = '';
      document.getElementById('search-clear-btn')?.classList.remove('visible');
      loadPreferences();
      fetchSessions().then(() => showAllTasks());
    }

    // DOM
    const sessionsList = document.getElementById('sessions-list');
    const noSession = document.getElementById('no-session');
    const sessionView = document.getElementById('session-view');
    const sessionTitle = document.getElementById('session-title');
    const sessionMeta = document.getElementById('session-meta');
    const progressPercent = document.getElementById('progress-percent');
    const progressBar = document.getElementById('progress-bar');
    const pendingTasks = document.getElementById('pending-tasks');
    const inProgressTasks = document.getElementById('in-progress-tasks');
    const completedTasks = document.getElementById('completed-tasks');
    const pendingCount = document.getElementById('pending-count');
    const inProgressCount = document.getElementById('in-progress-count');
    const completedCount = document.getElementById('completed-count');
    const detailPanel = document.getElementById('detail-panel');
    const detailContent = document.getElementById('detail-content');
    const connectionStatus = document.getElementById('connection-status');
    const COLUMNS = [
      { el: pendingTasks },
      { el: inProgressTasks },
      { el: completedTasks },
    ];

    let lastSessionsHash = '';
    let lastTasksHash = '';

    async function fetchSessions() {
      log.debug('[fetchSessions] Starting...');
      try {
        const limitParam = sessionLimit === 'all' ? '9999' : sessionLimit;
        const res = await fetch(`/api/sessions?limit=${limitParam}`);
        const newSessions = await res.json();
        const tasksRes = await fetch('/api/tasks/all');
        const newTasks = await tasksRes.json();

        const sessionsHash = JSON.stringify(newSessions);
        const tasksHash = JSON.stringify(newTasks);
        if (sessionsHash === lastSessionsHash && tasksHash === lastTasksHash) {
          log.debug('[fetchSessions] No changes, skipping render');
          return;
        }
        lastSessionsHash = sessionsHash;
        lastTasksHash = tasksHash;

        // Track live session IDs
        const liveIds = new Set(newSessions.map(s => s.id));

        // Update known sessions with fresh data
        for (const s of newSessions) {
          knownSessions.set(s.id, s);
        }

        // Mark sessions that disappeared as completed (client-side only)
        // and preserve their tasks before they vanish.
        // Remove sessions that are outside the current limit and not completed.
        for (const [id, s] of knownSessions) {
          if (!liveIds.has(id) && !s.isCompleted) {
            // Check if this session had tasks â€” if so, it was real and just completed
            if (s.taskCount > 0) {
              log.debug('[fetchSessions] Session disappeared, marking completed:', id, s.name);
              const sessionTasks = allTasksCache
                .filter(t => t.sessionId === id)
                .map(t => ({ ...t, status: 'completed' }));
              completedTasksCache.push(...sessionTasks);

              s.isCompleted = true;
              s.peakTaskCount = s.taskCount || 0;
              s.completed = s.taskCount || 0;
              s.progress = 100;
              s.taskCount = sessionTasks.length || s.taskCount || 0;
              s.pending = 0;
              s.inProgress = 0;
              s.modifiedAt = new Date().toISOString();
            } else {
              // Session with no tasks fell outside the limit â€” just drop it
              knownSessions.delete(id);
            }
          }
        }

        log.debug('[fetchSessions] knownSessions:', knownSessions.size, 'live:', liveIds.size,
          'completed:', [...knownSessions.values()].filter(s => s.isCompleted).length);

        sessions = [...knownSessions.values()];
        allTasksCache = [...newTasks, ...completedTasksCache];

        // Detect task completions and fire notifications
        const newStatuses = new Map();
        for (const task of allTasksCache) {
          if (task.sessionId && task.id) {
            newStatuses.set(`${task.sessionId}:${task.id}`, task.status);
          }
        }
        if (notificationsEnabled && previousTaskStatuses.size > 0) {
          for (const task of allTasksCache) {
            const key = `${task.sessionId}:${task.id}`;
            const oldStatus = previousTaskStatuses.get(key);
            if (oldStatus === 'in_progress' && task.status === 'completed') {
              fireTaskNotification(task);
            }
          }
        }
        previousTaskStatuses = newStatuses;

        log.debug('[fetchSessions] Sessions loaded:', sessions.length, '(known:', knownSessions.size, ')');
        renderSessions();
        log.debug('[fetchSessions] Render complete');
        fetchLiveUpdates();
      } catch (error) {
        log.error('Failed to fetch sessions:', error);
      }
    }

    function handleSearch(query) {
      searchQuery = query.toLowerCase().trim();

      // Show/hide clear button
      const clearBtn = document.getElementById('search-clear-btn');
      if (searchQuery) {
        clearBtn.classList.add('visible');
      } else {
        clearBtn.classList.remove('visible');
      }

      updateUrl();
      renderSessions();
    }

    function clearSearch() {
      const searchInput = document.getElementById('search-input');
      searchInput.value = '';
      searchQuery = '';
      document.getElementById('search-clear-btn').classList.remove('visible');
      updateUrl();
      renderSessions();
    }

    function deleteAllSessionTasks(sessionId) {
      const session = sessions.find(s => s.id === sessionId);
      if (!session) return;

      // When viewing a single session, currentTasks already contains only that session's tasks
      // When viewing "All Tasks", tasks have sessionId property, so we filter
      const sessionTasks = currentSessionId === sessionId
        ? currentTasks
        : currentTasks.filter(t => t.sessionId === sessionId);

      if (sessionTasks.length === 0) {
        alert('No tasks to delete in this session');
        return;
      }

      bulkDeleteSessionId = sessionId;

      const displayName = session.name || sessionId;
      const message = `Delete all ${sessionTasks.length} task(s) from session "${displayName}"?`;

      document.getElementById('delete-session-tasks-message').textContent = message;

      const modal = document.getElementById('delete-session-tasks-modal');
      modal.classList.add('visible');

      // Handle ESC key
      const keyHandler = (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeDeleteSessionTasksModal();
          document.removeEventListener('keydown', keyHandler);
        }
      };
      document.addEventListener('keydown', keyHandler);
    }

    function closeDeleteSessionTasksModal() {
      const modal = document.getElementById('delete-session-tasks-modal');
      modal.classList.remove('visible');
      bulkDeleteSessionId = null;
    }

    async function confirmDeleteSessionTasks() {
      if (!bulkDeleteSessionId) return;

      const sessionId = bulkDeleteSessionId;
      closeDeleteSessionTasksModal();

      // Get tasks to delete
      const sessionTasks = currentSessionId === sessionId
        ? currentTasks
        : currentTasks.filter(t => t.sessionId === sessionId);

      // Sort tasks by dependency order (blocked tasks first, then blockers)
      const sortedTasks = topologicalSort(sessionTasks);

      let successCount = 0;
      let failedCount = 0;
      const failedTasks = [];

      for (const task of sortedTasks) {
        try {
          const res = await fetch(`/api/tasks/${sessionId}/${task.id}`, {
            method: 'DELETE'
          });

          if (res.ok) {
            successCount++;
          } else {
            failedCount++;
            const error = await res.json();
            failedTasks.push({ id: task.id, subject: task.subject, error: error.error });
            log.error(`Failed to delete task ${task.id}:`, error);
          }
        } catch (error) {
          failedCount++;
          failedTasks.push({ id: task.id, subject: task.subject, error: 'Network error' });
          log.error(`Error deleting task ${task.id}:`, error);
        }
      }

      // Show result modal
      showDeleteResultModal(successCount, failedCount, failedTasks);

      // Close detail panel if open
      closeDetailPanel();

      // Refresh the view
      await refreshCurrentView();
    }

    // Topological sort for task deletion order
    function topologicalSort(tasks) {
      const result = [];
      const visited = new Set();
      const visiting = new Set();
      const taskMap = new Map(tasks.map(t => [t.id, t]));

      function visit(taskId) {
        if (visited.has(taskId)) return;
        if (visiting.has(taskId)) return; // Cycle - skip

        visiting.add(taskId);
        const task = taskMap.get(taskId);

        if (task && task.blocks && task.blocks.length > 0) {
          // Visit all tasks that this task blocks (dependencies first)
          for (const blockedId of task.blocks) {
            if (taskMap.has(blockedId)) {
              visit(blockedId);
            }
          }
        }

        visiting.delete(taskId);
        visited.add(taskId);
        if (task) result.push(task);
      }

      // Visit all tasks
      for (const task of tasks) {
        visit(task.id);
      }

      return result;
    }

    function showDeleteResultModal(successCount, failedCount, failedTasks) {
      const modal = document.getElementById('delete-result-modal');
      const messageEl = document.getElementById('delete-result-message');
      const detailsEl = document.getElementById('delete-result-details');

      if (failedCount === 0) {
        messageEl.textContent = `Successfully deleted all ${successCount} task(s).`;
        detailsEl.style.display = 'none';
      } else {
        messageEl.textContent = `Deleted ${successCount} task(s). Failed to delete ${failedCount} task(s).`;

        const failedList = failedTasks.map(t =>
          `<li><strong>${escapeHtml(t.subject)}</strong> (#${escapeHtml(t.id)}): ${escapeHtml(t.error)}</li>`
        ).join('');
        detailsEl.innerHTML = `<ul style="margin: 8px 0 0 0; padding-left: 20px;">${failedList}</ul>`;
        detailsEl.style.display = 'block';
      }

      modal.classList.add('visible');

      // Handle ESC key
      const keyHandler = (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeDeleteResultModal();
          document.removeEventListener('keydown', keyHandler);
        }
      };
      document.addEventListener('keydown', keyHandler);
    }

    function closeDeleteResultModal() {
      const modal = document.getElementById('delete-result-modal');
      modal.classList.remove('visible');
    }

    function fuzzyMatch(text, query) {
      if (!query) return true;
      if (!text) return false;

      text = text.toLowerCase();
      query = query.toLowerCase();

      // Prioritize exact substring match
      if (text.includes(query)) return true;

      // Split by common delimiters to search in individual words
      const words = text.split(/[\s\-_\/\.]+/);

      // Check if query matches start of any word
      for (const word of words) {
        if (word.startsWith(query)) return true;
      }

      // Check if any word contains the query
      for (const word of words) {
        if (word.includes(query)) return true;
      }

      return false;
    }

    async function fetchLiveUpdates() {
      try {
        const res = await fetch('/api/tasks/all');
        const allTasks = await res.json();
        let activeTasks = allTasks.filter(t => t.status === 'in_progress');
        if (filterProject) {
          activeTasks = activeTasks.filter(t => matchesProjectFilter(t.project));
        }
        renderLiveUpdates(activeTasks);
      } catch (error) {
        log.error('Failed to fetch live updates:', error);
      }
    }

    function renderLiveUpdates(activeTasks) {
      const section = document.getElementById('live-updates-section');
      const container = document.getElementById('live-updates');

      if (activeTasks.length === 0) {
        section.style.display = 'none';
        container.innerHTML = '';
        return;
      }

      section.style.display = '';
      container.innerHTML = activeTasks.map(task => `
        <div class="live-item" data-action="openLiveTask" data-session-id="${task.sessionId}" data-task-id="${task.id}">
          <span class="pulse"></span>
          <div class="live-item-content">
            <div class="live-item-action" title="${escapeHtml(task.activeForm || task.subject)}">${escapeHtml(task.activeForm || task.subject)}</div>
            <div class="live-item-session" title="${escapeHtml(task.sessionName || task.sessionId)}">${escapeHtml(task.sessionName || task.sessionId)}</div>
          </div>
        </div>
      `).join('');
    }

    async function fetchSubagents(sessionId) {
      const section = document.getElementById('subagent-section');
      if (!sessionId || viewMode === 'all') {
        section.style.display = 'none';
        currentSubagents = [];
        return;
      }
      try {
        const res = await fetch(`/api/sessions/${sessionId}/subagents`);
        currentSubagents = await res.json();
        const activeCount = currentSubagents.filter(a => a.isActive).length;
        const visibleAgents = showAllSubagents ? currentSubagents : currentSubagents.filter(a => a.isActive);
        if (currentSubagents.length === 0 || (!showAllSubagents && activeCount === 0)) {
          section.style.display = 'none';
          return;
        }
        section.style.display = '';
        const countLabel = showAllSubagents
          ? `${activeCount} active / ${currentSubagents.length} total`
          : `${activeCount}`;
        document.getElementById('subagent-count').textContent = countLabel;
        const filterToggle = document.getElementById('subagent-filter-toggle');
        filterToggle.textContent = showAllSubagents ? 'Active only' : `Show all (${currentSubagents.length})`;
        filterToggle.style.display = currentSubagents.length > activeCount ? '' : 'none';
        renderSubagentCards(visibleAgents);
      } catch (error) {
        log.error('Failed to fetch subagents:', error);
        section.style.display = 'none';
      }
    }

    function renderSubagentCards(agents) {
      const container = document.getElementById('subagent-cards');
      container.innerHTML = agents.map(agent => `
        <div class="subagent-card ${agent.isActive ? 'active' : ''}" data-action="toggleSubagentDetail">
          <div class="subagent-card-header">
            <span class="subagent-status-dot ${agent.isActive ? 'active' : ''}"></span>
            <span>${escapeHtml(agent.slug || agent.agentId)}</span>
            ${agent.model ? `<span class="subagent-model">${escapeHtml(agent.model)}</span>` : ''}
          </div>
          ${agent.description ? `<div class="subagent-desc" title="${escapeHtml(agent.description)}">${escapeHtml(agent.description)}</div>` : ''}
          <div class="subagent-time">${agent.startedAt ? formatDate(agent.startedAt) : ''} ${agent.isActive ? 'Â· Active' : `Â· Last: ${formatDate(agent.lastActivityAt)}`}</div>
          <div class="subagent-detail">
            <div class="subagent-detail-row"><span class="subagent-detail-label">Agent</span><span class="subagent-detail-value">${escapeHtml(agent.agentId)}</span></div>
            ${agent.model ? `<div class="subagent-detail-row"><span class="subagent-detail-label">Model</span><span class="subagent-detail-value">${escapeHtml(agent.model)}</span></div>` : ''}
            ${agent.cwd ? `<div class="subagent-detail-row"><span class="subagent-detail-label">Dir</span><span class="subagent-detail-value" title="${escapeHtml(agent.cwd)}">${escapeHtml(agent.cwd)}</span></div>` : ''}
            ${agent.startedAt ? `<div class="subagent-detail-row"><span class="subagent-detail-label">Started</span><span class="subagent-detail-value">${new Date(agent.startedAt).toLocaleString()}</span></div>` : ''}
            <div class="subagent-detail-row"><span class="subagent-detail-label">Last</span><span class="subagent-detail-value">${new Date(agent.lastActivityAt).toLocaleString()}</span></div>
            ${agent.description ? `<div class="subagent-detail-row"><span class="subagent-detail-label">Task</span><span class="subagent-detail-value" title="${escapeHtml(agent.description)}">${escapeHtml(agent.description)}</span></div>` : ''}
          </div>
        </div>
      `).join('');
    }

    function toggleSubagentFilter() {
      showAllSubagents = !showAllSubagents;
      if (currentSessionId) {
        fetchSubagents(currentSessionId);
      }
    }

    function toggleSubagents() {
      const header = document.querySelector('.subagent-header');
      const cards = document.getElementById('subagent-cards');
      header.classList.toggle('collapsed');
      cards.style.display = header.classList.contains('collapsed') ? 'none' : '';
    }

    async function openLiveTask(sessionId, taskId) {
      await fetchTasks(sessionId);
      showTaskDetail(taskId, sessionId);
    }

    let lastCurrentTasksHash = '';

    async function fetchTasks(sessionId) {
      try {
        viewMode = 'session';
        const res = await fetch(`/api/sessions/${sessionId}`);

        let newTasks;
        if (res.ok) {
          newTasks = await res.json();
        } else if (res.status === 404) {
          newTasks = [];
        } else {
          throw new Error(`Failed to fetch tasks: ${res.status}`);
        }

        // Fall back to cached tasks for completed sessions
        if (newTasks.length === 0) {
          const cached = completedTasksCache.filter(t => t.sessionId === sessionId);
          if (cached.length > 0) {
            newTasks = cached;
          }
        }

        const hash = JSON.stringify(newTasks);
        if (sessionId === currentSessionId && hash === lastCurrentTasksHash) {
          log.debug('[fetchTasks] No changes, skipping render');
          return;
        }
        lastCurrentTasksHash = hash;

        currentTasks = newTasks;
        currentSessionId = sessionId;
        ownerFilter = '';
        updateUrl();
        renderSession();
        fetchSubagents(sessionId);
      } catch (error) {
        log.error('Failed to fetch tasks:', error);
        currentTasks = [];
        currentSessionId = sessionId;
        lastCurrentTasksHash = '';
        updateUrl();
        renderSession();
        fetchSubagents(sessionId);
      }
    }

    async function showAllTasks() {
      try {
        viewMode = 'all';
        currentSessionId = null;
        ownerFilter = '';
        const res = await fetch('/api/tasks/all');
        let tasks = await res.json();
        if (filterProject) {
          tasks = tasks.filter(t => matchesProjectFilter(t.project));
        }
        currentTasks = tasks;
        updateUrl();
        renderAllTasks();
        fetchSubagents(null);
        renderSessions();
      } catch (error) {
        log.error('Failed to fetch all tasks:', error);
      }
    }

    function renderAllTasks() {
      noSession.style.display = 'none';
      sessionView.classList.add('visible');
      document.getElementById('owner-filter-bar').classList.remove('visible');

      const totalTasks = currentTasks.length;
      const completed = currentTasks.filter(t => t.status === 'completed').length;
      const percent = totalTasks > 0 ? Math.round((completed / totalTasks) * 100) : 0;

      const isFiltered = filterProject && filterProject !== '__recent__';
      const projectName = isFiltered ? filterProject.split(/[/\\]/).pop() : null;
      sessionTitle.textContent = isFiltered ? `Tasks: ${projectName}` : (filterProject === '__recent__' ? 'Recent Tasks' : 'All Tasks');

      sessionMeta.textContent = isFiltered
        ? `${totalTasks} tasks in this project`
        : `${totalTasks} tasks across ${sessions.length} sessions`;
      progressPercent.textContent = `${percent}%`;
      progressBar.style.width = `${percent}%`;

      renderKanban();
      if (currentView === 'timeline') renderTimeline();
      applyView();
    }

    function isSessionStale(session) {
      if (session.inProgress > 0) return false;
      const modifiedAt = new Date(session.modifiedAt);
      const daysAgo = (Date.now() - modifiedAt.getTime()) / (1000 * 60 * 60 * 24);
      return daysAgo > ARCHIVE_DAYS;
    }

    function toggleArchived() {
      archivedExpanded = !archivedExpanded;
      localStorage.setItem('archivedExpanded', String(archivedExpanded));
      const header = document.querySelector('.archived-header');
      const container = document.querySelector('.archived-sessions');
      if (header) header.classList.toggle('expanded', archivedExpanded);
      if (container) container.classList.toggle('visible', archivedExpanded);
    }

    function renderSessionItem(session, isArchived) {
      const total = session.taskCount;
      const percent = total > 0 ? Math.round((session.completed / total) * 100) : 0;
      const isActive = session.id === currentSessionId && viewMode === 'session';
      const hasInProgress = session.inProgress > 0;
      const sessionName = session.name || session.id;
      const projectName = session.project ? session.project.split(/[/\\]/).pop() : null;
      const primaryName = projectName || sessionName;
      const secondaryName = projectName && projectName !== sessionName ? sessionName : null;
      const gitBranch = session.gitBranch ? escapeHtml(session.gitBranch) : null;
      const createdDisplay = session.createdAt ? formatDate(session.createdAt) : '';
      const modifiedDisplay = formatDate(session.modifiedAt);
      const timeDisplay = session.createdAt && createdDisplay !== modifiedDisplay
        ? `Created ${createdDisplay} Â· Modified ${modifiedDisplay}`
        : modifiedDisplay;
      const tooltip = [timeDisplay, gitBranch ? `Branch: ${gitBranch}` : ''].filter(Boolean).join(' | ');
      const isTeam = session.isTeam;
      const memberCount = session.memberCount || 0;
      const archivedClass = isArchived ? ' archived' : '';

      return `
        <button data-action="fetchTasks" data-session-id="${session.id}" class="session-item${archivedClass} ${isActive ? 'active' : ''}" title="${tooltip}">
          <div class="session-name">${escapeHtml(primaryName)}</div>
          ${secondaryName ? `<div class="session-secondary">${escapeHtml(secondaryName)}</div>` : ''}
          ${gitBranch ? `<div class="session-branch">${gitBranch}</div>` : ''}
          ${session.project ? `<div class="session-project" title="${escapeHtml(session.project)}">${escapeHtml(session.project)}</div>` : ''}
          ${session.planTitle ? `<div class="session-plan">${escapeHtml(session.planTitle)}</div>` : ''}
          <div class="session-progress">
            <span class="session-indicators">
              ${isTeam ? `<span class="team-badge" title="${memberCount} team members"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>${memberCount}</span>` : ''}
              <span class="team-info-btn" data-action="showSessionInfoModal" data-session-id="${session.id}" title="View session info">â„¹</span>
              ${session.isCompleted ? `<span class="completed-badge" title="Completed (${session.peakTaskCount} tasks)">Done ${session.peakTaskCount}</span>` : ''}
              ${session.activeSubagentCount > 0 ? `<span class="subagent-badge" title="${session.activeSubagentCount} active subagent${session.activeSubagentCount !== 1 ? 's' : ''} (${session.subagentCount} total)"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>${session.activeSubagentCount}</span>` : ''}
              ${session.hasPlan ? `<span class="plan-indicator" data-action="openPlanForSession" data-session-id="${session.slug || session.id}" title="View plan"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></span>` : ''}
              ${session.project ? `<span class="session-project-actions"><span class="session-project-btn" data-action="copyPath" data-path="${escapeHtml(session.project)}" title="Copy path"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></span><span class="session-project-btn" data-action="openFolder" data-path="${escapeHtml(session.project)}" title="Open in explorer"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></span></span>` : ''}
              ${hasInProgress ? '<span class="pulse"></span>' : ''}
            </span>
            <div class="progress-bar"><div class="progress-fill" style="width: ${percent}%"></div></div>
            <span class="progress-text">${session.isCompleted ? 'Done' : `${session.completed}/${total}`}</span>
          </div>
          <div class="session-time">${formatDate(session.modifiedAt)}</div>
        </button>
      `;
    }

    function renderSessions() {
      // Update project dropdown
      updateProjectDropdown();

      let filteredSessions = sessions;
      if (sessionFilter === 'active') {
        filteredSessions = filteredSessions.filter(s =>
          s.isCompleted || s.pending > 0 || s.inProgress > 0 || s.hasPlan || s.activeSubagentCount > 0
        );
      }
      if (filterProject) {
        // Always show client-side completed sessions regardless of project filter
        filteredSessions = filteredSessions.filter(s =>
          s.isCompleted || matchesProjectFilter(s.project, s.modifiedAt)
        );
      }

      // Apply search filter
      if (searchQuery) {
        filteredSessions = filteredSessions.filter(session => {
          // Search in session name and ID
          if (session.name && fuzzyMatch(session.name, searchQuery)) return true;
          if (session.id && fuzzyMatch(session.id, searchQuery)) return true;

          // Search in project path
          if (session.project && fuzzyMatch(session.project, searchQuery)) return true;

          // Search in description
          if (session.description && fuzzyMatch(session.description, searchQuery)) return true;

          // Search in tasks for this session
          const sessionTasks = allTasksCache.filter(t => t.sessionId === session.id);
          return sessionTasks.some(task =>
            (task.subject && fuzzyMatch(task.subject, searchQuery)) ||
            (task.description && fuzzyMatch(task.description, searchQuery)) ||
            (task.activeForm && fuzzyMatch(task.activeForm, searchQuery))
          );
        });
      }

      // Split into active and archived sessions
      const activeSessions = [];
      const archivedSessions = [];
      for (const session of filteredSessions) {
        if (searchQuery || sessionFilter === 'active') {
          activeSessions.push(session);
        } else if (isSessionStale(session)) {
          archivedSessions.push(session);
        } else {
          activeSessions.push(session);
        }
      }

      if (activeSessions.length === 0 && archivedSessions.length === 0) {
        let emptyMsg = 'No sessions found';
        let emptyHint = 'Tasks appear when you use Claude Code';

        if (searchQuery) {
          emptyMsg = `No results for "${searchQuery}"`;
          emptyHint = 'Try a different search term or clear the search';
        } else if (filterProject && sessionFilter === 'active') {
          emptyMsg = 'No active sessions for this project';
          emptyHint = 'Try "All Sessions" or "All Projects"';
        } else if (filterProject) {
          emptyMsg = 'No sessions for this project';
          emptyHint = 'Select "All Projects" to see all';
        } else if (sessionFilter === 'active') {
          emptyMsg = 'No active sessions';
          emptyHint = 'Select "All Sessions" to see all';
        }
        sessionsList.innerHTML = `
          <div style="padding: 24px 12px; text-align: center; color: var(--text-muted); font-size: 12px;">
            <p>${emptyMsg}</p>
            <p style="margin-top: 8px; font-size: 11px;">${emptyHint}</p>
          </div>
        `;
        return;
      }

      sessionsList.innerHTML = activeSessions.map(s => renderSessionItem(s)).join('');

      // Append archived section if there are stale sessions
      if (archivedSessions.length > 0) {
        sessionsList.innerHTML += `
          <div class="archived-header ${archivedExpanded ? 'expanded' : ''}" data-action="toggleArchived">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18l6-6-6-6"/>
            </svg>
            <span>Archived (${archivedSessions.length})</span>
          </div>
          <div class="archived-sessions ${archivedExpanded ? 'visible' : ''}">
            ${archivedSessions.map(session => renderSessionItem(session, true)).join('')}
          </div>
        `;
      }

      const items = getSessionItems();
      const activeIdx = items.findIndex(el => el.classList.contains('active'));
      if (activeIdx >= 0) selectedSessionIdx = activeIdx;

      if (focusZone === 'sidebar' && selectedSessionIdx >= 0) {
        if (items.length > 0) {
          const clamped = Math.min(selectedSessionIdx, items.length - 1);
          selectedSessionIdx = clamped;
          items[clamped].classList.add('kb-selected');
        } else {
          selectedSessionIdx = -1;
        }
      }
    }

    function renderSession() {
      noSession.style.display = 'none';
      sessionView.classList.add('visible');

      const session = sessions.find(s => s.id === currentSessionId);
      if (!session) return;

      if (session.isCompleted && currentTasks.length === 0) {
        sessionTitle.textContent = session.name || currentSessionId;
        sessionMeta.textContent = `Completed Â· ${session.peakTaskCount} tasks were processed`;
        progressPercent.textContent = '100%';
        progressBar.style.width = '100%';
        pendingTasks.innerHTML = '<div class="column-empty"><div>Session completed</div></div>';
        inProgressTasks.innerHTML = '<div class="column-empty"><div>All tasks finished</div></div>';
        completedTasks.innerHTML = '<div class="column-empty"><div>Tasks cleaned up</div></div>';
        pendingCount.textContent = '0';
        inProgressCount.textContent = '0';
        completedCount.textContent = '0';
        document.getElementById('owner-filter-bar').classList.remove('visible');
        fetchSubagents(currentSessionId);
        return;
      }

      const displayName = session.name || currentSessionId;
      const headerProject = session.project ? session.project.split(/[/\\]/).pop() : null;
      const headerSuffix = headerProject && headerProject !== displayName ? ` <span style="font-size: 12px; font-weight: 400; color: var(--text-muted);">${escapeHtml(headerProject)}</span>` : '';

      // Create header with delete button
      sessionTitle.innerHTML = `
        <span style="flex: 1;">${escapeHtml(displayName)}${headerSuffix}</span>
        <button class="icon-btn icon-btn-danger" data-action="deleteAllSessionTasks" data-session-id="${session.id}" title="Delete all tasks in this session">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
        </button>
      `;

      // Build meta text with project path, branch, and description
      const projectName = session.project ? session.project.split('/').pop() : null;
      const metaParts = [session.isCompleted ? `Completed Â· ${currentTasks.length} tasks` : `${currentTasks.length} tasks`];
      if (projectName) {
        metaParts.push(projectName);
      }
      if (session.gitBranch) {
        metaParts.push(session.gitBranch);
      }
      if (session.description) {
        metaParts.push(session.description);
      }
      metaParts.push(formatDate(session.modifiedAt));
      sessionMeta.textContent = metaParts.join(' Â· ');

      const completed = currentTasks.filter(t => t.status === 'completed').length;
      const percent = currentTasks.length > 0 ? Math.round((completed / currentTasks.length) * 100) : 0;

      progressPercent.textContent = `${percent}%`;
      progressBar.style.width = `${percent}%`;
      const hasInProgress = currentTasks.some(t => t.status === 'in_progress');
      progressBar.classList.toggle('shimmer', hasInProgress && percent < 100);

      updateOwnerFilter();
      renderKanban();
      if (currentView === 'timeline') {
        renderTimeline();
      }
      applyView();
      renderSessions();
    }

    function isTaskActuallyBlocked(task) {
      if (!task.blockedBy || task.blockedBy.length === 0) return false;
      return task.blockedBy.some(id => {
        const blockingTask = currentTasks.find(t =>
          t.id === id && (viewMode !== 'all' || t.sessionId === task.sessionId)
        );
        return !blockingTask || blockingTask.status !== 'completed';
      });
    }

    function renderTaskCard(task) {
      const isBlocked = isTaskActuallyBlocked(task);
      const taskId = viewMode === 'all' ? `${task.sessionId?.slice(0,4)}-${task.id}` : task.id;
      const sessionLabel = viewMode === 'all' && task.sessionName ? task.sessionName : null;
      const statusClass = task.status.replace('_', '-');
      const actualSessionId = task.sessionId || currentSessionId;

      return `
        <div
          role="listitem"
          tabindex="0"
          data-task-id="${task.id}"
          data-session-id="${actualSessionId}"
          data-action="showTaskDetail"
          class="task-card ${statusClass} ${isBlocked ? 'blocked' : ''}"
          aria-label="${escapeHtml(task.subject)} â€” ${task.status.replace('_',' ')}">
          <div class="task-id">
            <span>#${taskId}</span>
            ${isBlocked ? '<span class="task-badge blocked">Blocked</span>' : ''}
            ${task.owner ? (() => { const c = getOwnerColor(task.owner); return `<span class="task-owner-badge" style="background:${c.bg};color:${c.color};cursor:pointer" data-action="showAgentInstruction" data-owner="${escapeHtml(task.owner)}" data-session-id="${actualSessionId}">${escapeHtml(task.owner)}</span>`; })() : ''}
          </div>
          <div class="task-title">${escapeHtml(task.subject)}</div>
          ${sessionLabel ? `<div class="task-session">${escapeHtml(sessionLabel)}</div>` : ''}
          ${task.status === 'in_progress' && task.activeForm ? `<div class="task-active">${escapeHtml(task.activeForm)}</div>` : ''}
          ${isBlocked ? `<div class="task-blocked">Waiting on ${task.blockedBy.map(id => '#' + id).join(', ')}</div>` : ''}
          ${task.description ? `<div class="task-desc">${escapeHtml(task.description.split('\n')[0])}</div>` : ''}
        </div>
      `;
    }

    function renderKanban() {
      let filtered = currentTasks.filter(t => !t.metadata?._internal);
      if (ownerFilter) {
        filtered = filtered.filter(t => t.owner === ownerFilter);
      }
      const pending = filtered.filter(t => t.status === 'pending');
      const inProgress = filtered.filter(t => t.status === 'in_progress');
      const completed = filtered.filter(t => t.status === 'completed');

      pendingCount.textContent = pending.length;
      inProgressCount.textContent = inProgress.length;
      completedCount.textContent = completed.length;

      const emptyIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>`;

      pendingTasks.innerHTML = pending.length > 0
        ? pending.map(renderTaskCard).join('')
        : `<div class="column-empty">${emptyIcon}<div>No pending tasks</div></div>`;

      inProgressTasks.innerHTML = inProgress.length > 0
        ? inProgress.map(renderTaskCard).join('')
        : `<div class="column-empty">${emptyIcon}<div>No active tasks</div></div>`;

      completedTasks.innerHTML = completed.length > 0
        ? completed.map(renderTaskCard).join('')
        : `<div class="column-empty">${emptyIcon}<div>No completed tasks</div></div>`;

      if (selectedTaskId) {
        const card = document.querySelector(`.task-card[data-task-id="${selectedTaskId}"][data-session-id="${selectedSessionId}"]`)
          || document.querySelector(`.task-card[data-task-id="${selectedTaskId}"]`);
        if (card) {
          if (focusZone === 'board') card.classList.add('selected');
        } else {
          selectedTaskId = null;
          selectedSessionId = null;
        }
      }
    }

    function selectTask(taskId, sessionId) {
      const prev = document.querySelector('.task-card.selected');
      if (prev) prev.classList.remove('selected');
      selectedTaskId = taskId;
      selectedSessionId = sessionId;
      if (!taskId) return;
      const card = document.querySelector(`.task-card[data-task-id="${taskId}"][data-session-id="${sessionId}"]`)
        || document.querySelector(`.task-card[data-task-id="${taskId}"]`);
      if (card) {
        card.classList.add('selected');
        card.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    }

    function getSelectedCardInfo() {
      if (!selectedTaskId) return null;
      for (let ci = 0; ci < COLUMNS.length; ci++) {
        const cards = Array.from(COLUMNS[ci].el.querySelectorAll('.task-card'));
        for (let i = 0; i < cards.length; i++) {
          if (cards[i].dataset.taskId === selectedTaskId) {
            return { colIndex: ci, cardIndex: i, card: cards[i] };
          }
        }
      }
      return null;
    }

    function navigateVertical(direction) {
      const info = getSelectedCardInfo();
      if (!info) {
        for (const col of COLUMNS) {
          const cards = Array.from(col.el.querySelectorAll('.task-card'));
          if (cards.length > 0) {
            selectTask(cards[0].dataset.taskId, cards[0].dataset.sessionId);
            return;
          }
        }
        return;
      }
      const cards = Array.from(COLUMNS[info.colIndex].el.querySelectorAll('.task-card'));
      const newIndex = info.cardIndex + direction;
      if (newIndex >= 0 && newIndex < cards.length) {
        selectTask(cards[newIndex].dataset.taskId, cards[newIndex].dataset.sessionId);
      }
    }

    function navigateHorizontal(direction) {
      const info = getSelectedCardInfo();
      if (!info) {
        navigateVertical(1);
        return;
      }
      let newColIndex = info.colIndex + direction;
      while (newColIndex >= 0 && newColIndex < COLUMNS.length) {
        const cards = Array.from(COLUMNS[newColIndex].el.querySelectorAll('.task-card'));
        if (cards.length > 0) {
          const clampedIndex = Math.min(info.cardIndex, cards.length - 1);
          selectTask(cards[clampedIndex].dataset.taskId, cards[clampedIndex].dataset.sessionId);
          return;
        }
        newColIndex += direction;
      }
    }

    function getSessionItems() {
      return Array.from(sessionsList.querySelectorAll('.session-item'));
    }

    function selectSessionByIndex(idx) {
      const items = getSessionItems();
      if (items.length === 0) return;
      const prev = sessionsList.querySelector('.session-item.kb-selected');
      if (prev) prev.classList.remove('kb-selected');
      selectedSessionIdx = Math.max(0, Math.min(idx, items.length - 1));
      items[selectedSessionIdx].classList.add('kb-selected');
      items[selectedSessionIdx].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }

    function navigateSession(direction) {
      const items = getSessionItems();
      if (items.length === 0) return;
      if (selectedSessionIdx < 0) {
        selectSessionByIndex(0);
        return;
      }
      const newIdx = selectedSessionIdx + direction;
      if (newIdx >= 0 && newIdx < items.length) {
        selectSessionByIndex(newIdx);
      }
    }

    function activateSelectedSession() {
      const items = getSessionItems();
      if (selectedSessionIdx >= 0 && selectedSessionIdx < items.length) {
        items[selectedSessionIdx].click();
      }
    }

    function setFocusZone(zone) {
      const sidebar = document.querySelector('.sidebar');
      // Clear all zone visuals
      sidebar.classList.remove('sidebar-focused');
      const prevSession = sessionsList.querySelector('.session-item.kb-selected');
      if (prevSession) prevSession.classList.remove('kb-selected');
      const selCard = document.querySelector('.task-card.selected');
      if (selCard) selCard.classList.remove('selected');

      focusZone = zone;
      if (zone === 'sidebar') {
        if (sidebar.classList.contains('collapsed')) {
          sidebar.classList.remove('collapsed');
          localStorage.setItem('sidebar-collapsed', false);
        }
        sidebar.classList.add('sidebar-focused');
        const items = getSessionItems();
        if (selectedSessionIdx < 0 && items.length > 0) {
          const activeIdx = items.findIndex(el => el.classList.contains('active'));
          selectSessionByIndex(activeIdx >= 0 ? activeIdx : 0);
        } else if (items.length > 0) {
          selectSessionByIndex(selectedSessionIdx);
        }
      } else {
        // Session changed while in sidebar â€” reset stale selection
        if (selectedSessionId && selectedSessionId !== currentSessionId) {
          selectedTaskId = null;
          selectedSessionId = null;
        }
        if (selectedTaskId) {
          const card = document.querySelector(`.task-card[data-task-id="${selectedTaskId}"][data-session-id="${selectedSessionId}"]`);
          if (card) card.classList.add('selected');
        } else {
          navigateVertical(1);
        }
        if (selectedTaskId && detailPanel.classList.contains('visible')) {
          showTaskDetail(selectedTaskId, selectedSessionId);
        }
      }
    }

    function getAvailableTasksOptions(currentTaskId = null) {
      const pending = currentTasks.filter(t => t.status === 'pending' && t.id !== currentTaskId);
      const inProgress = currentTasks.filter(t => t.status === 'in_progress' && t.id !== currentTaskId);
      const completed = currentTasks.filter(t => t.status === 'completed' && t.id !== currentTaskId);

      // Build options grouped by status
      let options = '';

      if (pending.length > 0) {
        options += '<optgroup label="Pending">';
        pending.forEach((t, idx) => {
          options += `<option value="${t.id}">#${t.id} - ${escapeHtml(t.subject)}</option>`;
        });
        options += '</optgroup>';
      }

      if (inProgress.length > 0) {
        options += '<optgroup label="In Progress">';
        inProgress.forEach((t, idx) => {
          options += `<option value="${t.id}">#${t.id} - ${escapeHtml(t.subject)}</option>`;
        });
        options += '</optgroup>';
      }

      if (completed.length > 0) {
        options += '<optgroup label="Completed">';
        completed.forEach((t, idx) => {
          options += `<option value="${t.id}">#${t.id} - ${escapeHtml(t.subject)}</option>`;
        });
        options += '</optgroup>';
      }

      return options;
    }

    async function showTaskDetail(taskId, sessionId = null) {
      let task = currentTasks.find(t => t.id === taskId && (!sessionId || t.sessionId === sessionId));

      // If task not found in currentTasks, fetch it from the session
      if (!task && sessionId && sessionId !== 'undefined') {
        try {
          const res = await fetch(`/api/sessions/${sessionId}`);
          const tasks = await res.json();
          task = tasks.find(t => t.id === taskId);
          if (!task) return;
        } catch (error) {
          log.error('Failed to fetch task:', error);
          return;
        }
      }

      if (!task) return;

      const actualSid = task.sessionId || sessionId || currentSessionId;
      selectTask(taskId, actualSid);
      detailPanel.classList.add('visible');

      const statusLabels = {
        completed: '<span class="detail-status completed"><span class="dot"></span>Completed</span>',
        in_progress: '<span class="detail-status in_progress"><span class="dot"></span>In Progress</span>',
        pending: '<span class="detail-status pending"><span class="dot"></span>Pending</span>'
      };

      const isBlocked = isTaskActuallyBlocked(task);
      const actualSessionId = task.sessionId || sessionId || currentSessionId;

      detailContent.innerHTML = `
        <div class="detail-section">
          <div class="detail-label">Task #${task.id}</div>
          <h2 class="detail-title">${escapeHtml(task.subject)}</h2>
        </div>

        <div class="detail-section" style="display: flex; gap: 12px; align-items: center;">
          <div>${statusLabels[task.status] || ''}</div>
          ${task.owner ? `<div style="font-size: 13px; color: ${getOwnerColor(task.owner).color}; font-weight: 500;">${escapeHtml(task.owner)}</div>` : ''}
          ${isBlocked && task.status !== 'in_progress' ? '<div style="font-size: 10px; color: var(--warning);">Blocked</div>' : ''}
        </div>

        <div class="detail-section">
          <div class="detail-label">Description</div>
          <div class="detail-desc">${task.description ? DOMPurify.sanitize(marked.parse(task.description)) : '<em style="color: var(--text-muted);">No description</em>'}</div>
        </div>

        ${task.activeForm && task.status === 'in_progress' ? `
          <div class="detail-section">
            <div class="detail-box active">
              <strong>Currently:</strong> ${escapeHtml(task.activeForm)}
            </div>
          </div>
        ` : ''}

        <div class="detail-section">
          <div class="detail-label">Blocked By</div>
          <div class="detail-deps">
            ${task.blockedBy && task.blockedBy.length > 0
              ? `<div class="detail-box blocked"><strong>Blocked by:</strong> ${task.blockedBy.map(id => '#' + id).join(', ')}</div>`
              : '<em style="color: var(--text-muted); font-size: 13px;">No dependencies</em>'}
          </div>
        </div>

        <div class="detail-section">
          <div class="detail-label">Blocks</div>
          <div class="detail-deps">
            ${task.blocks && task.blocks.length > 0
              ? `<div class="detail-box blocks"><strong>Blocks:</strong> ${task.blocks.map(id => '#' + id).join(', ')}</div>`
              : '<em style="color: var(--text-muted); font-size: 13px;">No tasks blocked</em>'}
          </div>
        </div>

        <div class="detail-section note-section">
          <label for="note-input" class="detail-label">Add Note</label>
          <form class="note-form" onsubmit="addNote(event, '${task.id}', '${actualSessionId}')">
            <textarea id="note-input" class="note-input" placeholder="Add a note for Claude..." rows="3"></textarea>
            <button type="submit" class="note-submit">Add Note</button>
          </form>
        </div>
      `;

      // Setup button handlers
      const deleteBtn = document.getElementById('delete-task-btn');
      deleteBtn.style.display = '';
      deleteBtn.onclick = () => deleteTask(task.id, actualSessionId);

      // Setup inline editing
      const titleEl = detailContent.querySelector('.detail-title');
      if (titleEl) {
        titleEl.onclick = () => editTitle(titleEl, task, actualSessionId);
      }

      const descEl = detailContent.querySelector('.detail-desc');
      if (descEl) {
        descEl.onclick = () => editDescription(descEl, task, actualSessionId);
      }
    }

    function editTitle(titleEl, task, sessionId) {
      if (titleEl.querySelector('input')) return;
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'detail-title-input';
      input.value = task.subject;

      titleEl.replaceWith(input);
      input.focus();
      input.select();

      const save = async () => {
        const val = input.value.trim();
        if (val && val !== task.subject) {
          await saveTaskField(task.id, sessionId, 'subject', val);
        } else {
          showTaskDetail(task.id, sessionId);
        }
      };

      input.onkeydown = (e) => {
        if (e.key === 'Enter') { e.preventDefault(); save(); }
        if (e.key === 'Escape') showTaskDetail(task.id, sessionId);
      };
      input.onblur = () => save();
    }

    function editDescription(descEl, task, sessionId) {
      if (descEl.querySelector('textarea')) return;
      const wrapper = document.createElement('div');
      const textarea = document.createElement('textarea');
      textarea.className = 'detail-desc-textarea';
      textarea.value = task.description || '';
      textarea.rows = Math.max(5, (task.description || '').split('\n').length + 2);

      const actions = document.createElement('div');
      actions.className = 'edit-actions';

      const saveBtn = document.createElement('button');
      saveBtn.className = 'edit-save';
      saveBtn.textContent = 'Save';

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'edit-cancel';
      cancelBtn.textContent = 'Cancel';

      actions.append(cancelBtn, saveBtn);
      wrapper.append(textarea, actions);
      descEl.replaceWith(wrapper);
      textarea.focus();

      const save = async () => {
        const val = textarea.value;
        if (val !== (task.description || '')) {
          await saveTaskField(task.id, sessionId, 'description', val);
        } else {
          showTaskDetail(task.id, sessionId);
        }
      };

      saveBtn.onclick = save;
      cancelBtn.onclick = () => showTaskDetail(task.id, sessionId);
      textarea.onkeydown = (e) => {
        if (e.key === 'Escape') showTaskDetail(task.id, sessionId);
      };
    }

    async function saveTaskField(taskId, sessionId, field, value) {
      try {
        const res = await fetch(`/api/tasks/${sessionId}/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [field]: value })
        });

        if (res.ok) {
          lastCurrentTasksHash = null;
          if (viewMode === 'all') {
            const tasksRes = await fetch('/api/tasks/all');
            currentTasks = await tasksRes.json();
            renderKanban();
            if (currentView === 'timeline') renderTimeline();
          } else {
            await fetchTasks(sessionId);
          }
          showTaskDetail(taskId, sessionId);
        }
      } catch (error) {
        log.error('Failed to update task:', error);
      }
    }

    async function addNote(event, taskId, sessionId) {
      event.preventDefault();
      const input = document.getElementById('note-input');
      const note = input.value.trim();
      if (!note) return;

      try {
        const res = await fetch(`/api/tasks/${sessionId}/${taskId}/note`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ note })
        });

        if (res.ok) {
          input.value = '';
          // Refresh to show updated description
          if (viewMode === 'all') {
            const tasksRes = await fetch('/api/tasks/all');
            currentTasks = await tasksRes.json();
          } else {
            await fetchTasks(sessionId);
          }
          showTaskDetail(taskId, sessionId);
        }
      } catch (error) {
        log.error('Failed to add note:', error);
      }
    }

    function closeDetailPanel() {
      detailPanel.classList.remove('visible');
      document.getElementById('delete-task-btn').style.display = 'none';
    }

    let deleteTaskId = null;
    let deleteSessionId = null;
    let deleteModalKeyHandler = null;

    function showBlockedTaskModal(task) {
      const messageDiv = document.getElementById('blocked-task-message');

      const blockedByList = task.blockedBy.map(id => {
        const blockingTask = currentTasks.find(t => t.id === id);
        if (blockingTask) {
          return `<li><strong>#${blockingTask.id}</strong> - ${escapeHtml(blockingTask.subject)}</li>`;
        }
        return `<li><strong>#${id}</strong></li>`;
      }).join('');

      messageDiv.innerHTML = `
        <p style="margin-bottom: 12px;">Task <strong>#${task.id}</strong> - ${escapeHtml(task.subject)} is currently blocked by:</p>
        <ul style="margin: 0 0 16px 20px; padding: 0;">${blockedByList}</ul>
        <p style="margin: 0; color: var(--text-secondary); font-size: 13px;">
          Please resolve these dependencies before moving this task to <strong>In Progress</strong>.
        </p>
      `;

      const modal = document.getElementById('blocked-task-modal');
      modal.classList.add('visible');

      // Handle ESC key
      const keyHandler = (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeBlockedTaskModal();
          document.removeEventListener('keydown', keyHandler);
        }
      };
      document.addEventListener('keydown', keyHandler);
    }

    function closeBlockedTaskModal() {
      const modal = document.getElementById('blocked-task-modal');
      modal.classList.remove('visible');
    }

    function deleteTask(taskId, sessionId) {
      const task = currentTasks.find(t => t.id === taskId);
      if (!task) return;

      deleteTaskId = taskId;
      deleteSessionId = sessionId;

      const message = document.getElementById('delete-confirm-message');
      message.textContent = `Delete task "${task.subject}"? This cannot be undone.`;

      const modal = document.getElementById('delete-confirm-modal');
      modal.classList.add('visible');

      const buttons = [
        document.getElementById('delete-cancel-btn'),
        document.getElementById('delete-confirm-btn')
      ];
      let focusIdx = 1;
      buttons[focusIdx].focus();

      deleteModalKeyHandler = (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeDeleteConfirmModal();
        } else if (e.key === 'ArrowLeft' || e.key === 'h') {
          e.preventDefault();
          focusIdx = 0;
          buttons[focusIdx].focus();
        } else if (e.key === 'ArrowRight' || e.key === 'l') {
          e.preventDefault();
          focusIdx = 1;
          buttons[focusIdx].focus();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          buttons[focusIdx].click();
        }
      };
      document.addEventListener('keydown', deleteModalKeyHandler);
    }

    function closeDeleteConfirmModal() {
      const modal = document.getElementById('delete-confirm-modal');
      modal.classList.remove('visible');
      deleteTaskId = null;
      deleteSessionId = null;
      if (deleteModalKeyHandler) {
        document.removeEventListener('keydown', deleteModalKeyHandler);
        deleteModalKeyHandler = null;
      }
    }

    async function confirmDelete() {
      if (!deleteTaskId || !deleteSessionId) return;

      const taskId = deleteTaskId;
      const sessionId = deleteSessionId;

      closeDeleteConfirmModal();

      try {
        const res = await fetch(`/api/tasks/${sessionId}/${taskId}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          closeDetailPanel();
          await refreshCurrentView();
        } else {
          const error = await res.json();
          alert('Failed to delete task: ' + (error.error || 'Unknown error'));
        }
      } catch (error) {
        log.error('Failed to delete task:', error);
        alert('Failed to delete task');
      }
    }

    let _helpModalKeyHandler = null;

    function showHelpModal() {
      const modal = document.getElementById('help-modal');
      modal.classList.add('visible');

      if (_helpModalKeyHandler) {
        document.removeEventListener('keydown', _helpModalKeyHandler);
      }
      _helpModalKeyHandler = (e) => {
        if (e.key === 'Escape' || e.key === '?') {
          e.preventDefault();
          closeHelpModal();
        }
      };
      document.addEventListener('keydown', _helpModalKeyHandler);
    }

    function closeHelpModal() {
      const modal = document.getElementById('help-modal');
      modal.classList.remove('visible');
      if (_helpModalKeyHandler) {
        document.removeEventListener('keydown', _helpModalKeyHandler);
        _helpModalKeyHandler = null;
      }
    }

    async function refreshCurrentView() {
      fetchLiveUpdates();
      if (viewMode === 'all') {
        await showAllTasks();
      } else if (currentSessionId) {
        await fetchTasks(currentSessionId);
      } else {
        await fetchSessions();
      }
    }

    document.getElementById('close-detail').onclick = closeDetailPanel;

    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        return;
      }

      if (document.querySelector('.modal-overlay.visible')) return;

      if (e.key === '[') {
        e.preventDefault();
        toggleSidebar();
        return;
      }

      // Tab toggles focus zone
      if (e.key === 'Tab') {
        e.preventDefault();
        setFocusZone(focusZone === 'board' ? 'sidebar' : 'board');
        return;
      }

      // Sidebar navigation
      if (focusZone === 'sidebar') {
        if (e.key === 'j' || e.key === 'ArrowDown') {
          e.preventDefault();
          navigateSession(1);
          return;
        }
        if (e.key === 'k' || e.key === 'ArrowUp') {
          e.preventDefault();
          navigateSession(-1);
          return;
        }
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          activateSelectedSession();
          return;
        }
        if (e.key === 'Escape') {
          setFocusZone('board');
          return;
        }
        if (e.key === 'p' || e.key === 'P') {
          e.preventDefault();
          const highlighted = sessionsList.querySelector('.session-item.kb-selected');
          const sid = highlighted?.dataset.sessionId || currentSessionId;
          if (sid) openPlanForSession(sid);
          return;
        }
        if (e.key === 'i' || e.key === 'I') {
          e.preventDefault();
          const highlighted = sessionsList.querySelector('.session-item.kb-selected');
          const sid = highlighted?.dataset.sessionId || currentSessionId;
          if (sid) showSessionInfoModal(sid);
          return;
        }
        if (e.key === 'c' || e.key === 'C') {
          e.preventDefault();
          const highlighted = sessionsList.querySelector('.session-item.kb-selected');
          const sid = highlighted?.dataset.sessionId || currentSessionId;
          const session = sessions.find(s => s.id === sid);
          if (session?.project) copyPath(session.project);
          return;
        }
        if (e.key === 'f' || e.key === 'F') {
          e.preventDefault();
          const highlighted = sessionsList.querySelector('.session-item.kb-selected');
          const sid = highlighted?.dataset.sessionId || currentSessionId;
          const session = sessions.find(s => s.id === sid);
          if (session?.project) openFolder(session.project);
          return;
        }
        if (e.key === '?' || (e.key === '/' && e.shiftKey)) {
          e.preventDefault();
          showHelpModal();
        }
        return;
      }

      // Board navigation
      const navKeys = ['j','k','h','l','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'];
      if (navKeys.includes(e.key)) {
        e.preventDefault();
        if (e.key === 'j' || e.key === 'ArrowDown') navigateVertical(1);
        else if (e.key === 'k' || e.key === 'ArrowUp') navigateVertical(-1);
        else if (e.key === 'h' || e.key === 'ArrowLeft') navigateHorizontal(-1);
        else if (e.key === 'l' || e.key === 'ArrowRight') navigateHorizontal(1);

        if (selectedTaskId && detailPanel.classList.contains('visible')) {
          showTaskDetail(selectedTaskId, selectedSessionId);
        }
        return;
      }

      if ((e.key === 'Enter' || e.key === ' ') && selectedTaskId && e.target.tagName !== 'BUTTON') {
        e.preventDefault();
        if (detailPanel.classList.contains('visible')) {
          const labelEl = document.querySelector('.detail-label');
          const shownId = labelEl?.textContent.match(/\d+/)?.[0];
          if (shownId === selectedTaskId) {
            closeDetailPanel();
          } else {
            showTaskDetail(selectedTaskId, selectedSessionId);
          }
        } else {
          showTaskDetail(selectedTaskId, selectedSessionId);
        }
        return;
      }

      if (e.key === 'Escape' && detailPanel.classList.contains('visible')) {
        closeDetailPanel();
      }

      if (e.key === 'p' || e.key === 'P') {
        e.preventDefault();
        const sid = selectedSessionId || currentSessionId;
        if (sid) openPlanForSession(sid);
        return;
      }

      if (e.key === 'i' || e.key === 'I') {
        e.preventDefault();
        const sid = selectedSessionId || currentSessionId;
        if (sid) showSessionInfoModal(sid);
        return;
      }

      if (e.key === 'c' || e.key === 'C') {
        e.preventDefault();
        const sid = selectedSessionId || currentSessionId;
        const session = sessions.find(s => s.id === sid);
        if (session?.project) copyPath(session.project);
        return;
      }

      if (e.key === 'f' || e.key === 'F') {
        e.preventDefault();
        const sid = selectedSessionId || currentSessionId;
        const session = sessions.find(s => s.id === sid);
        if (session?.project) openFolder(session.project);
        return;
      }

      if ((e.key === 'd' || e.key === 'D') && selectedTaskId) {
        e.preventDefault();
        deleteTask(selectedTaskId, selectedSessionId || currentSessionId);
      }

      if (e.key === '?' || (e.key === '/' && e.shiftKey)) {
        e.preventDefault();
        showHelpModal();
      }
    });

    let isServerConnected = false;

    function setupEventSource() {
      let retryDelay = 1000;
      let retryCount = 0;
      let eventSource;

      function connect() {
        eventSource = new EventSource('/api/events');

        eventSource.onopen = () => {
          const wasDisconnected = !isServerConnected;
          isServerConnected = true;
          retryDelay = 1000;
          retryCount = 0;
          document.getElementById('reconnect-overlay')?.classList.remove('visible');
          connectionStatus.innerHTML = `
            <span class="connection-dot live"></span>
            <span>Connected</span>
          `;
          if (wasDisconnected) {
            fetchSessions().catch(() => {});
            if (currentSessionId) fetchTasks(currentSessionId);
          }
        };

        eventSource.onerror = () => {
          eventSource.close();
          isServerConnected = false;
          retryCount++;
          connectionStatus.innerHTML = `
            <span class="connection-dot error"></span>
            <span>Disconnected</span>
          `;
          const overlay = document.getElementById('reconnect-overlay');
          const attemptEl = document.getElementById('reconnect-attempt');
          if (retryCount >= 2 && overlay) {
            overlay.classList.add('visible');
          }
          if (attemptEl) {
            attemptEl.textContent = `Retry #${retryCount} in ${Math.round(retryDelay / 1000)}s...`;
          }
          setTimeout(connect, retryDelay);
          retryDelay = Math.min(retryDelay * 2, 30000);
        };

        let refreshTimer = null;
        function debouncedRefresh(sessionId, isMetadata) {
          clearTimeout(refreshTimer);
          if (!isServerConnected) return;
          const delay = isMetadata ? 2000 : 500;
          refreshTimer = setTimeout(() => {
            if (!isServerConnected) return;
            fetchSessions().catch(err => log.error('[SSE] fetchSessions failed:', err));
            if (currentSessionId && (isMetadata || sessionId === currentSessionId)) {
              fetchTasks(currentSessionId);
              fetchSubagents(currentSessionId);
            }
          }, delay);
        }

        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);
          log.debug('[SSE] Event received:', data);
          if (data.type === 'update' || data.type === 'metadata-update') {
            debouncedRefresh(data.sessionId, data.type === 'metadata-update');
          }

          if (data.type === 'plan-update') {
            refreshOpenPlan();
          }

          if (data.type === 'team-update') {
            log.debug('[SSE] Team update:', data.teamName);
            debouncedRefresh(data.teamName, false);
            if (currentSessionId && data.teamName === currentSessionId) {
              fetchTasks(currentSessionId);
            }
          }
        };
      }

      connect();
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      return date.toLocaleDateString();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function copyPath(path) {
      navigator.clipboard.writeText(path).then(() => {
        const el = document.getElementById('toast');
        el.textContent = 'Path copied';
        el.classList.add('visible');
        setTimeout(() => el.classList.remove('visible'), 1500);
      });
    }

    function openFolder(path) {
      fetch('/api/open-folder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path })
      }).catch(() => {});
    }

    // --- Notification functions ---

    function toggleNotifications() {
      if (!notificationsEnabled && Notification.permission !== 'granted') {
        Notification.requestPermission().then(perm => {
          if (perm === 'granted') {
            notificationsEnabled = true;
            localStorage.setItem('notificationsEnabled', 'true');
            updateNotificationButton();
          }
        });
      } else {
        notificationsEnabled = !notificationsEnabled;
        localStorage.setItem('notificationsEnabled', String(notificationsEnabled));
        updateNotificationButton();
      }
    }

    function updateNotificationButton() {
      const btn = document.getElementById('notifications-toggle');
      if (notificationsEnabled) {
        btn.classList.add('notifications-active');
        btn.title = 'Notifications on (click to mute)';
      } else {
        btn.classList.remove('notifications-active');
        btn.title = 'Notifications off (click to enable)';
      }
    }

    function fireTaskNotification(task) {
      if (Notification.permission === 'granted') {
        const n = new Notification('Task completed', {
          body: task.subject,
          tag: `task-${task.sessionId}-${task.id}`,
        });
        n.onclick = () => {
          window.focus();
          openLiveTask(task.sessionId, task.id);
          n.close();
        };
      }
      playChime();
    }

    function playChime() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const now = ctx.currentTime;
        const osc1 = ctx.createOscillator();
        const gain1 = ctx.createGain();
        osc1.frequency.value = 523;
        osc1.type = 'sine';
        gain1.gain.setValueAtTime(0.15, now);
        gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc1.connect(gain1);
        gain1.connect(ctx.destination);
        osc1.start(now);
        osc1.stop(now + 0.15);
        const osc2 = ctx.createOscillator();
        const gain2 = ctx.createGain();
        osc2.frequency.value = 659;
        osc2.type = 'sine';
        gain2.gain.setValueAtTime(0.15, now + 0.1);
        gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.25);
        osc2.connect(gain2);
        gain2.connect(ctx.destination);
        osc2.start(now + 0.1);
        osc2.stop(now + 0.25);
        setTimeout(() => ctx.close(), 500);
      } catch (e) { /* Audio not available */ }
    }

    function applyView() {
      const kanbanBtn = document.getElementById('view-kanban-btn');
      const timelineBtn = document.getElementById('view-timeline-btn');
      const kanbanEl = document.getElementById('main-content');
      const timelineEl = document.getElementById('timeline-view');

      if (currentView === 'timeline') {
        kanbanBtn.classList.remove('active');
        timelineBtn.classList.add('active');
        kanbanEl.style.display = 'none';
        timelineEl.classList.add('visible');
      } else {
        timelineBtn.classList.remove('active');
        kanbanBtn.classList.add('active');
        timelineEl.classList.remove('visible');
        kanbanEl.style.display = '';
      }
    }

    function switchView(view) {
      currentView = view;
      localStorage.setItem('currentView', view);
      applyView();
      if (view === 'timeline') {
        renderTimeline();
      }
    }

    function renderTimeline() {
      const axisEl = document.getElementById('timeline-axis');
      const rowsEl = document.getElementById('timeline-rows');

      let filtered = currentTasks.filter(t => !t.metadata?._internal);
      if (ownerFilter) {
        filtered = filtered.filter(t => t.owner === ownerFilter);
      }

      if (filtered.length === 0) {
        axisEl.innerHTML = '';
        rowsEl.innerHTML = `
          <div class="timeline-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M3 6h18M3 12h12M3 18h16"/>
            </svg>
            <div>No tasks to display</div>
          </div>`;
        return;
      }

      const tasksWithTime = filtered.filter(t => t.createdAt);
      if (tasksWithTime.length === 0) {
        axisEl.innerHTML = '';
        rowsEl.innerHTML = `
          <div class="timeline-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M3 6h18M3 12h12M3 18h16"/>
            </svg>
            <div>No timestamp data available</div>
          </div>`;
        return;
      }

      tasksWithTime.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

      const minTime = new Date(tasksWithTime[0].createdAt).getTime();
      const maxTime = Math.max(
        ...tasksWithTime.map(t => new Date(t.updatedAt || t.createdAt).getTime()),
        Date.now()
      );
      const totalSpan = maxTime - minTime || 1;

      // Render axis labels
      const labelCount = 5;
      axisEl.innerHTML = '';
      for (let i = 0; i < labelCount; i++) {
        const t = minTime + (totalSpan * i / (labelCount - 1));
        const label = document.createElement('span');
        label.className = 'timeline-axis-label';
        label.textContent = formatTimelineLabel(t, totalSpan);
        axisEl.appendChild(label);
      }

      // Render rows
      rowsEl.innerHTML = '';
      for (const task of tasksWithTime) {
        const created = new Date(task.createdAt).getTime();
        const updated = new Date(task.updatedAt || task.createdAt).getTime();
        const left = ((created - minTime) / totalSpan) * 100;
        const width = Math.max(((updated - created) / totalSpan) * 100, 0.5);
        const statusClass = task.status.replace('_', '-');

        const row = document.createElement('div');
        row.className = 'timeline-row';
        row.innerHTML = `
          <span class="timeline-label" title="${escapeHtml(task.subject)}">#${escapeHtml(task.id)} ${escapeHtml(task.subject)}</span>
          <div class="timeline-bar-container">
            <div class="timeline-bar ${statusClass}"
                 style="left: ${left}%; width: ${width}%"
                 data-action="showTaskDetail"
                 data-task-id="${task.id}"
                 data-session-id="${task.sessionId || currentSessionId}"
                 data-title="${escapeHtml(task.subject)}"
                 data-created="${task.createdAt}"
                 data-updated="${task.updatedAt || task.createdAt}"
                 data-status="${task.status}">
            </div>
          </div>`;

        const bar = row.querySelector('.timeline-bar');
        bar.addEventListener('mouseenter', showTimelineTooltip);
        bar.addEventListener('mouseleave', hideTimelineTooltip);
        bar.addEventListener('mousemove', moveTimelineTooltip);
        rowsEl.appendChild(row);
      }
    }

    function formatTimelineLabel(timestamp, totalSpan) {
      const date = new Date(timestamp);
      const hours = totalSpan / (1000 * 60 * 60);

      if (hours < 1) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      } else if (hours < 24) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } else {
        return date.toLocaleDateString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      }
    }

    function showTimelineTooltip(e) {
      const bar = e.currentTarget;
      const tooltip = document.getElementById('timeline-tooltip');
      const titleEl = document.getElementById('tooltip-title');
      const timeEl = document.getElementById('tooltip-time');

      titleEl.textContent = bar.dataset.title;

      const created = new Date(bar.dataset.created);
      const updated = new Date(bar.dataset.updated);
      const duration = updated - created;
      const status = bar.dataset.status.replace('_', ' ');

      let durationStr;
      if (duration < 1000) {
        durationStr = 'just started';
      } else if (duration < 60000) {
        durationStr = `${Math.round(duration / 1000)}s`;
      } else if (duration < 3600000) {
        durationStr = `${Math.round(duration / 60000)}m`;
      } else {
        const h = Math.floor(duration / 3600000);
        const m = Math.round((duration % 3600000) / 60000);
        durationStr = `${h}h ${m}m`;
      }

      timeEl.textContent = `${status} Â· ${durationStr} Â· ${created.toLocaleTimeString()}`;
      tooltip.classList.add('visible');

      const rect = bar.getBoundingClientRect();
      tooltip.style.left = `${e.clientX + 12}px`;
      tooltip.style.top = `${rect.top - 40}px`;
    }

    function moveTimelineTooltip(e) {
      const tooltip = document.getElementById('timeline-tooltip');
      tooltip.style.left = `${e.clientX + 12}px`;
    }

    function hideTimelineTooltip() {
      document.getElementById('timeline-tooltip').classList.remove('visible');
    }

    const ownerColors = [
      { bg: 'rgba(37, 99, 235, 0.14)',  color: '#1d5bbf' },  // blue
      { bg: 'rgba(168, 85, 247, 0.14)', color: '#7c3aed' },  // purple
      { bg: 'rgba(14, 165, 133, 0.14)', color: '#0d7d65' },  // teal
      { bg: 'rgba(220, 80, 30, 0.14)',  color: '#c04a1a' },  // red-orange
      { bg: 'rgba(202, 138, 4, 0.14)',  color: '#92700c' },   // amber
      { bg: 'rgba(219, 39, 119, 0.14)', color: '#b5246a' },  // pink
      { bg: 'rgba(22, 163, 74, 0.14)',  color: '#15803d' },   // green
      { bg: 'rgba(99, 102, 241, 0.14)', color: '#4f46e5' },  // indigo
    ];
    const ownerColorCache = {};
    function getOwnerColor(name) {
      if (ownerColorCache[name]) return ownerColorCache[name];
      let hash = 5381;
      for (let i = 0; i < name.length; i++) {
        hash = ((hash * 33) ^ name.charCodeAt(i)) | 0;
      }
      const c = ownerColors[Math.abs(hash) % ownerColors.length];
      ownerColorCache[name] = c;
      return c;
    }

    function filterBySessions(value) {
      sessionFilter = value;
      updateUrl();
      renderSessions();
    }

    function changeSessionLimit(value) {
      sessionLimit = value;
      // Clear non-completed sessions so the new limit is respected
      for (const [id, s] of knownSessions) {
        if (!s.isCompleted) knownSessions.delete(id);
      }
      lastSessionsHash = null; // force re-render
      updateUrl();
      fetchSessions();
    }

    function matchesProjectFilter(project, modifiedAt) {
      if (!filterProject) return true;
      if (filterProject === '__recent__') {
        if (recentProjects.has(project)) return true;
        if (!project && modifiedAt) {
          return (Date.now() - new Date(modifiedAt).getTime()) < 24 * 60 * 60 * 1000;
        }
        return false;
      }
      return project === filterProject;
    }

    function filterByProject(project) {
      filterProject = project || null;
      updateUrl();
      renderSessions();
      fetchLiveUpdates();
      showAllTasks();
    }

    async function updateProjectDropdown() {
      const dropdown = document.getElementById('project-filter');
      let projects;
      try {
        const res = await fetch('/api/projects');
        projects = await res.json();
      } catch (e) {
        projects = [...new Set(sessions.map(s => s.project).filter(Boolean))].sort()
          .map(p => ({ path: p, modifiedAt: null }));
      }

      const cutoff = Date.now() - 24 * 60 * 60 * 1000;
      recentProjects = new Set(
        projects.filter(p => p.modifiedAt && new Date(p.modifiedAt).getTime() > cutoff).map(p => p.path)
      );

      const recentSelected = filterProject === '__recent__' ? ' selected' : '';
      dropdown.innerHTML =
        '<option value="">All Projects</option>' +
        `<option value="__recent__"${recentSelected}>Recent (24h)</option>` +
        projects.map(p => {
          const name = p.path.split(/[/\\]/).pop();
          const selected = p.path === filterProject ? ' selected' : '';
          return `<option value="${escapeHtml(p.path)}"${selected} title="${escapeHtml(p.path)}">${escapeHtml(name)}</option>`;
        }).join('');
    }

    function toggleTheme() {
      const isCurrentlyLight = document.body.classList.contains('light');
      if (isCurrentlyLight) {
        document.body.classList.remove('light');
        document.body.classList.add('dark-forced');
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.add('light');
        document.body.classList.remove('dark-forced');
        localStorage.setItem('theme', 'light');
      }
      updateThemeIcon();
      syncHljsTheme();
    }

    function syncHljsTheme() {
      const isLight = document.body.classList.contains('light');
      const dark = document.getElementById('hljs-theme-dark');
      const light = document.getElementById('hljs-theme-light');
      if (dark) dark.disabled = isLight;
      if (light) light.disabled = !isLight;
    }

    function updateThemeIcon() {
      const saved = localStorage.getItem('theme');
      const isLight = document.body.classList.contains('light') ||
        (!saved && window.matchMedia('(prefers-color-scheme: light)').matches);
      document.getElementById('theme-icon-dark').style.display = isLight ? 'none' : 'block';
      document.getElementById('theme-icon-light').style.display = isLight ? 'block' : 'none';
    }

    function loadTheme() {
      const saved = localStorage.getItem('theme');
      if (saved === 'light') {
        document.body.classList.add('light');
        document.body.classList.remove('dark-forced');
      } else if (saved === 'dark') {
        document.body.classList.remove('light');
        document.body.classList.add('dark-forced');
      }
      // If no saved preference, system prefers-color-scheme CSS handles it
      updateThemeIcon();
      syncHljsTheme();
    }

    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const collapsed = sidebar.classList.toggle('collapsed');
      localStorage.setItem('sidebar-collapsed', collapsed);
      if (collapsed) {
        sidebar.style.width = '';
        if (focusZone === 'sidebar') setFocusZone('board');
      } else {
        const w = getComputedStyle(sidebar).getPropertyValue('--sidebar-width');
        if (w) sidebar.style.width = w;
      }
    }

    function loadSidebarState() {
      const sidebar = document.querySelector('.sidebar');
      // Suppress the width transition on initial load so the sidebar
      // snaps to the stored width instead of animating from the default.
      sidebar.style.transition = 'none';
      if (localStorage.getItem('sidebar-collapsed') === 'true') {
        sidebar.classList.add('collapsed');
      }
      const w = localStorage.getItem('sidebar-width');
      if (w) {
        sidebar.style.setProperty('--sidebar-width', w);
      }
      // Re-enable transition after the browser has painted at the final width.
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          sidebar.style.transition = '';
        });
      });
    }

    function initSidebarResize() {
      const sidebar = document.querySelector('.sidebar');
      const handle = document.getElementById('sidebar-resize');
      let startX, startWidth;

      handle.addEventListener('mousedown', (e) => {
        if (sidebar.classList.contains('collapsed')) return;
        startX = e.clientX;
        startWidth = sidebar.offsetWidth;
        sidebar.classList.add('resizing');
        handle.classList.add('dragging');
        document.body.style.userSelect = 'none';
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
        e.preventDefault();
      });

      function onMove(e) {
        const w = Math.min(600, Math.max(200, startWidth + e.clientX - startX));
        sidebar.style.setProperty('--sidebar-width', w + 'px');
        sidebar.style.width = w + 'px';
      }

      function onUp() {
        sidebar.classList.remove('resizing');
        handle.classList.remove('dragging');
        document.body.style.userSelect = '';
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        localStorage.setItem('sidebar-width', sidebar.style.getPropertyValue('--sidebar-width'));
      }
    }

    function loadPreferences() {
      document.getElementById('session-filter').value = sessionFilter;
      document.getElementById('session-limit').value = sessionLimit;
    }

    async function showSessionInfoModal(sessionId) {
      const session = sessions.find(s => s.id === sessionId);
      if (!session) return;

      const promises = [];

      // Fetch team config
      let teamConfig = null;
      if (session.isTeam) {
        promises.push(
          fetch(`/api/teams/${sessionId}`).then(r => r.ok ? r.json() : null).catch(() => null)
            .then(data => { teamConfig = data; })
        );
      }

      // Fetch plan (plan files are named by slug, not session UUID)
      let planContent = null;
      const planSlug = session.slug || sessionId;
      promises.push(
        fetch(`/api/plans/${planSlug}`).then(r => r.ok ? r.json() : null).catch(() => null)
          .then(data => { planContent = data?.content || null; })
      );

      await Promise.all(promises);

      const tasks = currentSessionId === sessionId ? currentTasks : [];
      _planSlug = planSlug;
      showInfoModal(session, teamConfig, tasks, planContent);
    }

    let _pendingPlanContent = null;
    let _teamModalKeyHandler = null;

    function showInfoModal(session, teamConfig, tasks, planContent) {
      const modal = document.getElementById('team-modal');
      const titleEl = document.getElementById('team-modal-title');
      const bodyEl = document.getElementById('team-modal-body');

      titleEl.textContent = teamConfig
        ? `Team: ${teamConfig.team_name || teamConfig.name || 'Unknown'}`
        : (session.name || session.slug || session.id);

      let html = '';

      // Session & project details as compact key-value rows
      const infoRows = [];
      infoRows.push(['Session', `<span style="font-family: 'IBM Plex Mono', monospace; font-size: 11px; user-select: all;">${escapeHtml(session.id)}</span>`]);
      if (session.modifiedAt) {
        const d = new Date(session.modifiedAt);
        infoRows.push(['Last Modified', `${formatDate(session.modifiedAt)} <span style="font-size: 10px; color: var(--text-tertiary);">(${d.toLocaleString()})</span>`]);
      }
      if (session.project) {
        const projectName = session.project.split(/[/\\]/).pop();
        infoRows.push(['Project', `${escapeHtml(projectName)}<br><span style="font-size: 10px; color: var(--text-tertiary);">${escapeHtml(session.project)}</span>`]);
        if (session.gitBranch) {
          infoRows.push(['Branch', escapeHtml(session.gitBranch)]);
        }
        if (session.description) {
          infoRows.push(['Description', escapeHtml(session.description)]);
        }
      }
      html += `<div class="team-modal-meta" style="margin-bottom: 16px; display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; align-items: baseline;">`;
      infoRows.forEach(([label, value]) => {
        html += `<span style="font-weight: 500; color: var(--text-secondary); font-size: 12px; white-space: nowrap;">${label}</span><span>${value}</span>`;
      });
      html += `</div>`;

      // Action icons row (plan, copy, folder) â€” matching sidebar indicator style
      const actionIcons = [];
      if (planContent) {
        _pendingPlanContent = planContent;
        actionIcons.push(`<span class="plan-indicator" data-action="openPlanModal" title="View plan" style="cursor:pointer;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></span>`);
      }
      if (session.project) {
        actionIcons.push(`<span class="session-project-btn" data-action="copyPath" data-path="${escapeHtml(session.project)}" title="Copy path" style="cursor:pointer;"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></span>`);
        actionIcons.push(`<span class="session-project-btn" data-action="openFolder" data-path="${escapeHtml(session.project)}" title="Open in explorer" style="cursor:pointer;"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></span>`);
      }
      if (actionIcons.length > 0) {
        html += `<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 16px;">${actionIcons.join('')}</div>`;
      }

      // Team info section
      if (teamConfig) {
        const ownerCounts = {};
        tasks.forEach(t => {
          if (t.owner) ownerCounts[t.owner] = (ownerCounts[t.owner] || 0) + 1;
        });

        const members = teamConfig.members || [];
        const description = teamConfig.description || '';
        const lead = members.find(m => m.agentType === 'team-lead' || m.name === 'team-lead');

        if (description) {
          html += `<div class="team-modal-desc">"${escapeHtml(description)}"</div>`;
        }

        html += `<div style="font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 10px;">Members (${members.length})</div>`;

        members.forEach(member => {
          const taskCount = ownerCounts[member.name] || 0;
          html += `
            <div class="team-member-card" style="cursor: pointer;" data-action="showAgentInstruction" data-owner="${escapeHtml(member.name)}" data-session-id="${escapeHtml(session.id)}" title="Click to view agent instruction">
              <div class="member-name">ðŸŸ¢ ${escapeHtml(member.name)}</div>
              <div class="member-detail">Role: ${escapeHtml(member.agentType || 'unknown')}</div>
              ${member.model ? `<div class="member-detail">Model: ${escapeHtml(member.model)}</div>` : ''}
              <div class="member-tasks">Tasks: ${taskCount} assigned</div>
            </div>
          `;
        });

        const metaParts = [];
        if (teamConfig.created_at) {
          metaParts.push(`Created: ${new Date(teamConfig.created_at).toLocaleString()}`);
        }
        if (lead) {
          metaParts.push(`Lead: ${lead.name}`);
        }
        if (teamConfig.working_dir) {
          metaParts.push(`Working dir: ${teamConfig.working_dir}`);
        }
        if (metaParts.length > 0) {
          html += `<div class="team-modal-meta">${metaParts.map(p => escapeHtml(p)).join('<br>')}</div>`;
        }
      }

      bodyEl.innerHTML = html;
      modal.classList.add('visible');

      if (_teamModalKeyHandler) {
        document.removeEventListener('keydown', _teamModalKeyHandler);
      }
      _teamModalKeyHandler = (e) => {
        if (e.key === 'Escape') {
          if (document.getElementById('plan-modal').classList.contains('visible')) return;
          e.preventDefault();
          closeTeamModal();
        }
      };
      document.addEventListener('keydown', _teamModalKeyHandler);
    }

    function closeTeamModal() {
      document.getElementById('team-modal').classList.remove('visible');
      if (_teamModalKeyHandler) {
        document.removeEventListener('keydown', _teamModalKeyHandler);
        _teamModalKeyHandler = null;
      }
    }

    let _planSlug = null;
    let _planModalKeyHandler = null;
    let _agentModalKeyHandler = null;

    function refreshOpenPlan() {
      if (!_planSlug || !document.getElementById('plan-modal').classList.contains('visible')) return;
      fetch(`/api/plans/${_planSlug}`)
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if (data?.content) {
            _pendingPlanContent = data.content;
            const body = document.getElementById('plan-modal-body');
            body.innerHTML = DOMPurify.sanitize(marked.parse(_pendingPlanContent));
          }
        })
        .catch(() => {});
    }

    function openPlanForSession(sid) {
      const session = sessions.find(s => s.id === sid);
      const slug = session?.slug || sid;
      fetch(`/api/plans/${slug}`).then(r => r.ok ? r.json() : null).catch(() => null)
        .then(data => {
          if (data?.content) {
            _pendingPlanContent = data.content;
            _planSlug = slug;
            openPlanModal();
          }
        });
    }

    function openPlanModal() {
      if (!_pendingPlanContent) return;
      const body = document.getElementById('plan-modal-body');
      body.innerHTML = DOMPurify.sanitize(marked.parse(_pendingPlanContent));
      document.getElementById('plan-modal').classList.add('visible');

      if (_planModalKeyHandler) {
        document.removeEventListener('keydown', _planModalKeyHandler, true);
      }
      _planModalKeyHandler = (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          e.stopPropagation();
          closePlanModal();
        }
      };
      document.addEventListener('keydown', _planModalKeyHandler, true);
    }

    function closePlanModal() {
      document.getElementById('plan-modal').classList.remove('visible');
      if (_planModalKeyHandler) {
        document.removeEventListener('keydown', _planModalKeyHandler, true);
        _planModalKeyHandler = null;
      }
    }

    function openPlanInEditor() {
      if (!_planSlug) return;
      fetch(`/api/plans/${_planSlug}/open`, { method: 'POST' }).catch(() => {});
    }

    async function showAgentInstruction(agentName, sessionId) {
      const modal = document.getElementById('agent-modal');
      const titleEl = document.getElementById('agent-modal-title');
      const bodyEl = document.getElementById('agent-modal-body');

      titleEl.textContent = `Agent: ${agentName}`;
      bodyEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...</div>';
      modal.classList.add('visible');

      try {
        const res = await fetch(`/api/sessions/${sessionId}/agents`);
        if (!res.ok) {
          bodyEl.innerHTML = '<div style="color: var(--text-muted); padding: 12px;">Could not load agent tasks.</div>';
          return;
        }
        const agentTasks = await res.json();
        const agentTask = agentTasks.find(t => t.subject === agentName || t.owner === agentName);

        if (agentTask && agentTask.description) {
          const isTruncated = agentTask.description.length === 100;
          bodyEl.innerHTML = `<div style="white-space: pre-wrap; font-size: 13px; line-height: 1.6; color: var(--text-primary); font-family: 'IBM Plex Mono', monospace;">${escapeHtml(agentTask.description)}${isTruncated ? '...' : ''}</div>
            ${isTruncated ? '<div style="margin-top: 12px; padding: 8px 12px; background: var(--bg-elevated); border-radius: 6px; font-size: 11px; color: var(--text-muted);">Claude Code truncates agent instructions to 100 characters in task files.</div>' : ''}`;
        } else {
          bodyEl.innerHTML = '<div style="color: var(--text-muted); padding: 12px;">No instruction found for this agent.</div>';
        }
      } catch {
        bodyEl.innerHTML = '<div style="color: var(--text-muted); padding: 12px;">Failed to load agent instruction.</div>';
      }

      if (_agentModalKeyHandler) {
        document.removeEventListener('keydown', _agentModalKeyHandler, true);
      }
      _agentModalKeyHandler = (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          e.stopPropagation();
          closeAgentModal();
        }
      };
      document.addEventListener('keydown', _agentModalKeyHandler, true);
    }

    function closeAgentModal() {
      document.getElementById('agent-modal').classList.remove('visible');
      if (_agentModalKeyHandler) {
        document.removeEventListener('keydown', _agentModalKeyHandler, true);
        _agentModalKeyHandler = null;
      }
    }

    function updateOwnerFilter() {
      const bar = document.getElementById('owner-filter-bar');
      const select = document.getElementById('owner-filter');

      const session = sessions.find(s => s.id === currentSessionId);
      if (!session || !session.isTeam) {
        bar.classList.remove('visible');
        return;
      }

      bar.classList.add('visible');
      const owners = [...new Set(currentTasks.map(t => t.owner).filter(Boolean))].sort();
      select.innerHTML = '<option value="">All Members</option>' +
        owners.map(o => {
          const c = getOwnerColor(o);
          return `<option value="${escapeHtml(o)}" style="color:${c.color};background:${c.bg}"${o === ownerFilter ? ' selected' : ''}>${escapeHtml(o)}</option>`;
        }).join('');
      const current = ownerFilter ? getOwnerColor(ownerFilter) : null;
      select.style.color = current ? current.color : '';
      select.style.backgroundColor = current ? current.bg : '';
    }

    function filterByOwner(value) {
      ownerFilter = value;
      const select = document.getElementById('owner-filter');
      const c = value ? getOwnerColor(value) : null;
      select.style.color = c ? c.color : '';
      select.style.backgroundColor = c ? c.bg : '';
      updateUrl();
      renderKanban();
      if (currentView === 'timeline') {
        renderTimeline();
      }
    }

    // Sync sidebar header height with view header
    const sidebarHeader = document.querySelector('.sidebar-header');
    const viewHeader = document.querySelector('.view-header');
    new ResizeObserver(() => {
      sidebarHeader.style.height = viewHeader.offsetHeight + 'px';
    }).observe(viewHeader);

    // Init
    loadTheme();

    document.addEventListener('DOMContentLoaded', () => {
      if (typeof marked !== 'undefined' && typeof hljs !== 'undefined') {
        const renderer = new marked.Renderer();
        renderer.code = function({ text, lang }) {
          let highlighted;
          if (lang && hljs.getLanguage(lang)) {
            highlighted = hljs.highlight(text, { language: lang }).value;
          } else {
            highlighted = hljs.highlightAuto(text).value;
          }
          return `<pre><code class="hljs language-${escapeHtml(lang || '')}">${highlighted}</code></pre>`;
        };
        marked.use({ renderer });
      }
    });

    loadSidebarState();
    initSidebarResize();
    fetch('/api/version').then(r => r.json()).then(d => {
      document.getElementById('sidebar-footer').textContent = 'v' + d.version;
    }).catch(() => {});

    const urlState = getUrlState();
    sessionFilter = urlState.filter || 'active';
    sessionLimit = urlState.limit || '20';
    filterProject = urlState.project || '';
    ownerFilter = urlState.owner || '';
    searchQuery = urlState.search || '';

    loadPreferences();
    updateNotificationButton();
    setupEventSource();

    if (urlState.search) {
      document.getElementById('search-input').value = urlState.search;
      document.getElementById('search-clear-btn').classList.add('visible');
    }

    // Clear server-side task snapshots on page load so completed sessions
    // don't persist across refreshes (snapshots are in-memory only).
    fetch('/api/cache/clear', { method: 'POST' }).catch(() => {});

    fetchSessions().then(() => {
      document.getElementById('loading-state').style.display = 'none';
      document.querySelector('.sidebar').classList.remove('loading');
      if (urlState.session) {
        fetchTasks(urlState.session);
      } else {
        showAllTasks();
      }
    });

    window.addEventListener('popstate', () => {
      const s = getUrlState();
      sessionFilter = s.filter || 'active';
      sessionLimit = s.limit || '20';
      filterProject = s.project || '';
      ownerFilter = s.owner || '';
      searchQuery = s.search || '';
      loadPreferences();
      if (s.session) fetchTasks(s.session);
      else showAllTasks();
    });

    // Delegated event handler for all data-action clicks
    document.addEventListener('click', (e) => {
      // Stop propagation for clicks inside modals (prevents overlay close)
      const modal = e.target.closest('.modal');
      const overlay = e.target.closest('.modal-overlay');
      if (modal && overlay && !e.target.closest('[data-action]')) {
        return;
      }

      const actionEl = e.target.closest('[data-action]');
      if (!actionEl) return;

      const action = actionEl.dataset.action;
      const sessionId = actionEl.dataset.sessionId;
      const taskId = actionEl.dataset.taskId;
      const owner = actionEl.dataset.owner;

      switch (action) {
        // Sidebar
        case 'toggleSidebar': toggleSidebar(); break;
        case 'showAllTasks': showAllTasks(); break;
        case 'clearSearch': clearSearch(); break;
        case 'resetState': resetState(); break;
        case 'toggleNotifications': toggleNotifications(); break;
        case 'toggleArchived': toggleArchived(); break;
        case 'switchToKanban': switchView('kanban'); break;
        case 'switchToTimeline': switchView('timeline'); break;
        case 'toggleTheme': toggleTheme(); break;
        case 'showHelpModal': showHelpModal(); break;

        // Session list
        case 'fetchTasks': fetchTasks(sessionId); break;
        case 'showSessionInfoModal': e.stopPropagation(); showSessionInfoModal(sessionId); break;
        case 'openPlanModal': e.stopPropagation(); openPlanModal(); break;
        case 'openPlanForSession': e.stopPropagation(); openPlanForSession(sessionId); break;
        case 'copyPath': e.stopPropagation(); copyPath(actionEl.dataset.path); break;
        case 'openFolder': e.stopPropagation(); openFolder(actionEl.dataset.path); break;
        case 'deleteAllSessionTasks': deleteAllSessionTasks(sessionId); break;
        case 'toggleSubagents': toggleSubagents(); break;
        case 'toggleSubagentFilter': toggleSubagentFilter(); break;
        case 'toggleSubagentDetail': actionEl.closest('.subagent-card').classList.toggle('expanded'); break;

        // Task cards
        case 'showTaskDetail': showTaskDetail(taskId, sessionId); break;
        case 'showAgentInstruction': e.stopPropagation(); showAgentInstruction(owner, sessionId); break;
        case 'openLiveTask': openLiveTask(sessionId, taskId); break;

        // Modal close actions
        case 'closeHelpModal': closeHelpModal(); break;
        case 'closeDeleteConfirmModal': closeDeleteConfirmModal(); break;
        case 'closeDeleteSessionTasksModal': closeDeleteSessionTasksModal(); break;
        case 'closeDeleteResultModal': closeDeleteResultModal(); break;
        case 'closeTeamModal': closeTeamModal(); break;
        case 'closeAgentModal': closeAgentModal(); break;
        case 'closePlanModal': closePlanModal(); break;
        case 'closeBlockedTaskModal': closeBlockedTaskModal(); break;

        // Modal actions
        case 'confirmDelete': confirmDelete(); break;
        case 'confirmDeleteSessionTasks': confirmDeleteSessionTasks(); break;
        case 'openPlanInEditor': openPlanInEditor(); break;

        default: break;
      }
    });

    // Delegated input/change handlers
    document.getElementById('search-input').addEventListener('input', (e) => handleSearch(e.target.value));
    document.getElementById('project-filter').addEventListener('change', (e) => filterByProject(e.target.value));
    document.getElementById('session-filter').addEventListener('change', (e) => filterBySessions(e.target.value));
    document.getElementById('session-limit').addEventListener('change', (e) => changeSessionLimit(e.target.value));
  </script>

  <!-- Help Modal -->
  <div id="help-modal" class="modal-overlay" data-action="closeHelpModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Keyboard Shortcuts</h3>
        <button class="modal-close" aria-label="Close dialog" data-action="closeHelpModal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div style="display: grid; gap: 16px;">
          <div>
            <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 14px; font-weight: 600;">Global</h4>
            <table style="width: 100%; font-size: 13px;">
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">?</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Show keyboard shortcuts</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">Esc</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Close panels or cancel</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">Tab</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Toggle sidebar / board focus</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">[</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Toggle sidebar collapse</td>
              </tr>
            </table>
          </div>
          <div>
            <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 14px; font-weight: 600;">Navigation</h4>
            <table style="width: 100%; font-size: 13px;">
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">J</kbd> / <kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">&darr;</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Next task in column</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">K</kbd> / <kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">&uarr;</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Previous task in column</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">H</kbd> / <kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">&larr;</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Move to left column</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">L</kbd> / <kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">&rarr;</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Move to right column</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">Enter</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Toggle task detail panel</td>
              </tr>
            </table>
          </div>
          <div>
            <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 14px; font-weight: 600;">Task Actions</h4>
            <table style="width: 100%; font-size: 13px;">
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">I</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Open session info</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">P</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Open session plan</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">C</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Copy project path</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">F</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Open project folder</td>
              </tr>
              <tr>
                <td style="padding: 4px 0; color: var(--text-secondary);"><kbd style="background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; font-family: monospace;">D</kbd></td>
                <td style="padding: 4px 0; color: var(--text-primary);">Delete selected task</td>
              </tr>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-action="closeHelpModal">Got it</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-confirm-modal" class="modal-overlay" data-action="closeDeleteConfirmModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Delete Task</h3>
        <button class="modal-close" aria-label="Close dialog" data-action="closeDeleteConfirmModal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p id="delete-confirm-message" style="margin: 0; color: var(--text-primary);"></p>
      </div>
      <div class="modal-footer">
        <button id="delete-cancel-btn" class="btn btn-secondary" data-action="closeDeleteConfirmModal">Cancel</button>
        <button id="delete-confirm-btn" class="btn btn-primary" data-action="confirmDelete" style="background: #ef4444; border-color: #ef4444;">Delete</button>
      </div>
    </div>
  </div>

  <!-- Delete All Session Tasks Confirmation Modal -->
  <div id="delete-session-tasks-modal" class="modal-overlay" data-action="closeDeleteSessionTasksModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">Delete All Tasks</h3>
        <button class="modal-close" aria-label="Close dialog" data-action="closeDeleteSessionTasksModal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p id="delete-session-tasks-message" style="margin: 0 0 12px 0; color: var(--text-primary);"></p>
        <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeDeleteSessionTasksModal">Cancel</button>
        <button class="btn btn-primary" data-action="confirmDeleteSessionTasks" style="background: #ef4444; border-color: #ef4444;">Delete All</button>
      </div>
    </div>
  </div>

  <!-- Delete Result Modal -->
  <div id="delete-result-modal" class="modal-overlay" data-action="closeDeleteResultModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">Deletion Result</h3>
        <button class="modal-close" aria-label="Close dialog" data-action="closeDeleteResultModal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p id="delete-result-message" style="margin: 0; color: var(--text-primary);"></p>
        <div id="delete-result-details" style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-action="closeDeleteResultModal">Close</button>
      </div>
    </div>
  </div>

  <!-- Team Info Modal -->
  <div id="team-modal" class="modal-overlay" data-action="closeTeamModal">
    <div class="modal" style="max-width: 520px; max-height: 80vh; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h3 id="team-modal-title" class="modal-title">Team</h3>
        <button class="modal-close" aria-label="Close dialog" data-action="closeTeamModal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div id="team-modal-body" class="modal-body" style="overflow-y: auto; flex: 1;"></div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-action="closeTeamModal">Close</button>
      </div>
    </div>
  </div>

  <!-- Agent Instruction Modal (stacked on top of info modal) -->
  <div id="agent-modal" class="modal-overlay plan-modal-overlay" data-action="closeAgentModal">
    <div class="modal" style="max-width: 600px; max-height: 70vh; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h3 id="agent-modal-title" class="modal-title">Agent</h3>
        <button class="modal-close" aria-label="Close dialog" data-action="closeAgentModal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div id="agent-modal-body" class="modal-body" style="overflow-y: auto; flex: 1;"></div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-action="closeAgentModal">Close</button>
      </div>
    </div>
  </div>

  <!-- Plan Modal (stacked on top of info modal) -->
  <div id="plan-modal" class="modal-overlay plan-modal-overlay" data-action="closePlanModal">
    <div class="modal plan-modal">
      <div class="modal-header">
        <h3 id="plan-modal-title" class="modal-title">Plan</h3>
        <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 11px; margin-left: auto; margin-right: 12px;" data-action="openPlanInEditor">Open in Editor</button>
        <button class="modal-close" aria-label="Close dialog" data-action="closePlanModal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div id="plan-modal-body" class="modal-body detail-desc" style="overflow-y: auto; flex: 1;"></div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-action="closePlanModal">Close</button>
      </div>
    </div>
  </div>

  <!-- Blocked Task Warning Modal -->
  <div id="blocked-task-modal" class="modal-overlay" data-action="closeBlockedTaskModal">
    <div class="modal" style="max-width: 450px;">
      <div class="modal-header">
        <h3 class="modal-title" style="display: flex; align-items: center; gap: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" style="width: 20px; height: 20px;">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          Cannot Start Blocked Task
        </h3>
        <button class="modal-close" aria-label="Close dialog" data-action="closeBlockedTaskModal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div id="blocked-task-message" style="color: var(--text-primary); line-height: 1.6;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-action="closeBlockedTaskModal">OK</button>
      </div>
    </div>
  </div>
  <div id="toast"></div>
  <div id="reconnect-overlay">
    <div class="reconnect-box">
      <div class="reconnect-spinner"></div>
      <div class="reconnect-title">Server disconnected</div>
      <div class="reconnect-message">Attempting to reconnect...</div>
      <div class="reconnect-attempt" id="reconnect-attempt"></div>
    </div>
  </div>
</body>
</html>
